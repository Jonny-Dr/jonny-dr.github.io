
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†å¸ƒå¼é”Redis | åŒ—è¾°</title>
  <link rel="stylesheet" href="../../../css/common.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <style>
    .post-content {
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.8;
    }
    .post-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .post-header h1 {
      font-size: 2.2rem;
      margin-bottom: 1rem;
      color: var(--primary);
    }
    .post-meta {
      color: #888;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }
    .post-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }
    .post-tag {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .post-tag.category {
      background: rgba(72, 187, 120, 0.1);
      color: #48bb78;
    }
    .post-tag.language {
      background: rgba(237, 137, 54, 0.1);
      color: #ed8936;
    }
    .post-body {
      margin-bottom: 2rem;
    }
    .post-body h2 {
      font-size: 1.8rem;
      margin: 2rem 0 1rem;
      color: var(--primary);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .post-body h3 {
      font-size: 1.4rem;
      margin: 1.5rem 0 0.8rem;
      color: var(--primary);
    }
    .post-body p {
      margin-bottom: 1.2rem;
    }
    .post-body a {
      color: var(--primary);
      text-decoration: none;
    }
    .post-body a:hover {
      text-decoration: underline;
    }
    .post-body ul,
    .post-body ol {
      margin: 1rem 0 1.5rem 1.5rem;
    }
    .post-body li {
      margin-bottom: 0.5rem;
    }
    .post-body pre {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1.5rem 0;
      border: 1px solid var(--border);
    }
    .post-body code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 0.9rem;
    }
    .post-body pre code {
      background: none;
      padding: 0;
    }
    .post-body img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1.5rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .post-original-link {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border);
      color: #6c757d;
    }
    .post-original-link a {
      color: var(--primary);
      text-decoration: none;
    }
    .post-original-link a:hover {
      text-decoration: underline;
    }
    @media (max-width: 768px) {
      .post-content {
        padding: 0 1rem;
      }
      .post-header h1 {
        font-size: 1.8rem;
      }
      .post-tags {
        gap: 0.5rem;
      }
      .post-tag {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      .post-body pre {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>

  <button class="music-toggle" id="musicToggle" aria-label="æ§åˆ¶éŸ³ä¹">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
  </button>

  <header>
    <h1>ğŸŒ± åŒ—è¾°çš„åšå®¢</h1>
    <p class="subtitle">è®°å½•æ€è€ƒï¼Œåˆ†äº«æˆé•¿ | ä¸€ä¸ªçƒ­çˆ±æŠ€æœ¯çš„æ¢ç´¢è€…</p>
    <nav>
  <a href="../../index.html">é¦–é¡µ</a>
  <a href="../../project.html">é¡¹ç›®</a>
  <a href="../../skill.html">æŠ€æœ¯</a>
  <a href="../../daily.html">æ—¥å¸¸</a>
  <a href="../../about.html">å…³äº</a>
  <a href="../../archives.html">å½’æ¡£</a>
  <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>
</nav>
  </header>

  <main class="post-content">
    <article>
      <div class="post-header">
        <h1>åˆ†å¸ƒå¼é”Redis</h1>
        <div class="post-meta">å‘å¸ƒæ—¥æœŸï¼š2025-01-02</div>
        
        <div class="post-tags">
          <span class="post-tag category">æŠ€æœ¯</span> <span class="post-tag category">åç«¯ä¸­é—´ä»¶</span>
          
        </div>
        
      </div>
      <div class="post-body">
        <h1>åˆ†å¸ƒå¼é”Redis</h1>
<p></p>
<h1>2 Redisåˆ†å¸ƒå¼é”</h1>
<p></p>
<p>ç”¨åˆ°åˆ†å¸ƒå¼é”è¯´æ˜é‡åˆ°äº†å¤šä¸ªè¿›ç¨‹å…±åŒè®¿é—®åŒä¸€ä¸ªèµ„æºçš„é—®é¢˜ï¼Œ ä¸€èˆ¬æ˜¯åœ¨ä¸¤ä¸ªåœºæ™¯ä¸‹ä¼šé˜²æ­¢å¯¹åŒä¸€ä¸ªèµ„æºçš„é‡å¤è®¿é—®ï¼š</p>
<p></p>
<ul><ol><li>æé«˜æ•ˆç‡ã€‚æ¯”å¦‚å¤šä¸ªèŠ‚ç‚¹è®¡ç®—åŒä¸€æ‰¹ä»»åŠ¡ï¼Œå¦‚æœæŸä¸ªä»»åŠ¡å·²ç»æœ‰èŠ‚ç‚¹åœ¨è®¡ç®—äº†ï¼Œé‚£å…¶ä»–èŠ‚ç‚¹å°±ä¸ç”¨é‡å¤è®¡ç®—äº†ï¼Œä»¥å…æµªè´¹è®¡ç®—èµ„æºã€‚ä¸è¿‡é‡å¤è®¡ç®—ä¹Ÿæ²¡äº‹ï¼Œä¸ä¼šé€ æˆå…¶ä»–æ›´å¤§çš„æŸå¤±ã€‚ä¹Ÿå°±æ˜¯å…è®¸å¶å°”çš„å¤±è´¥ã€‚</li>
<p></p>
<p>  ä¾‹å¦‚ï¼šè°ƒç”¨æŸä¸ªå¼€å‘å¹³å°ï¼Œè·å–è®¿é—®ä»¤ç‰Œï¼ˆæœ‰æœ‰æ•ˆæœŸï¼‰ï¼Œç¼“å­˜åˆ°redisä¸­ï¼Œå¦‚æœredisæ²¡æœ‰è°ƒç”¨æ–¹æ³•è·å–è®¿é—®ä»¤ç‰Œã€‚é›†ç¾¤ç¯å¢ƒä¸‹å›å‡ºç°é‡å¤è·å–è®¿é—®ä»¤ç‰Œå¯¼è‡´è´¦æˆ·è¢«å°ç¦ã€‚</p>
<p></p>
<li>ä¿è¯æ­£ç¡®æ€§ã€‚åŠ åˆ†å¸ƒå¼é”åŒæ ·å¯ä»¥é¿å…ç ´åæ­£ç¡®æ€§çš„å‘ç”Ÿï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹åœ¨åŒä¸€æ¡æ•°æ®è¿›è¡Œæ“ä½œï¼ˆupdateå¢åŠ /å‡å°‘ï¼‰ï¼Œæ¯”å¦‚å¤šä¸ªèŠ‚ç‚¹æœºå™¨å¯¹åŒä¸€ä¸ªè®¢å•æ“ä½œä¸åŒçš„æµç¨‹æœ‰å¯èƒ½ä¼šå¯¼è‡´è¯¥ç¬”è®¢å•æœ€åçŠ¶æ€å‡ºç°é”™è¯¯ï¼Œé€ æˆæŸå¤±ã€‚è¿™ç§æƒ…å†µå¯¹é”çš„è¦æ±‚å°±å¾ˆé«˜äº†ï¼Œå¦‚æœé‡å¤è®¡ç®—ï¼Œä¼šå¯¹æ­£ç¡®æ€§é€ æˆå½±å“ã€‚è¿™ç§ä¸å…è®¸å¤±è´¥ã€‚-----ä¸¾ä¾‹ï¼šå…³é—­è¶…æ—¶æœªæ”¯ä»˜è®¢å•ï¼Œæ¢å¤åº“å­˜</li>
<p></p>
<p>å®ç°åˆ†å¸ƒå¼é”ï¼š</p>
<p></p>
<li>æ•°æ®åº“</li>
<p>  - è¡¨ï¼šæä¾›ä¸€å¼ è¡¨ é€šè¿‡æ˜¯å¦æœ‰è®°å½•è¡¨ç¤ºé”æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹è·å–äº†</p>
<p>  - æ‚²è§‚é”ï¼šfor update   ï¼›            select åº“å­˜ for update;    æ›´æ–°åº“å­˜ update åº“å­˜</p>
<p>  - ä¹è§‚é”ï¼šçº¿ç¨‹ä¸€ï¼šæŸ¥è¯¢åº“å­˜ å¾—åˆ°è®°å½•ç‰ˆæœ¬å·ï¼š1   ä¿®æ”¹åº“å­˜ï¼šupdate åº“å­˜+1  where å½“å‰ç‰ˆæœ¬å·=è®°å½•ç‰ˆæœ¬å·ã€‚çº¿ç¨‹äºŒï¼šæŸ¥è¯¢ä¿®æ”¹ä¹‹é—´ä¿®æ”¹è®°å½• ç‰ˆæœ¬å·ï¼š2</p>
<li>redis</li>
<p></p>
<p>å› ä¸ºRediså…·å¤‡é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€é«˜å¹¶å‘çš„ç‰¹æ€§ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨Redisæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚</p>
<p></p>
<h2>2.1 Redisåˆ†å¸ƒå¼é”åŸç†</h2>
<p></p>
<p>ä¸Šé¢è®²è¿‡ï¼Œåˆ†å¸ƒå¼é”çš„å…³é”®æ˜¯<strong>å¤šè¿›ç¨‹å…±äº«çš„å†…å­˜æ ‡è®°(é”)</strong>ï¼Œå› æ­¤åªè¦æˆ‘ä»¬åœ¨Redisä¸­æ”¾ç½®ä¸€ä¸ªè¿™æ ·çš„æ ‡è®°(æ•°æ®)å°±å¯ä»¥äº†ã€‚ä¸è¿‡åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œä¸è¦å¿˜äº†æˆ‘ä»¬éœ€è¦å®ç°ä¸‹åˆ—ç›®æ ‡ï¼š</p>
<p></p>
<li>å¤šè¿›ç¨‹å¯è§ï¼šå¤šè¿›ç¨‹å¯è§ï¼Œå¦åˆ™å°±æ— æ³•å®ç°åˆ†å¸ƒå¼æ•ˆæœ</li>
<p></p>
<li>é¿å…æ­»é”ï¼šæ­»é”çš„æƒ…å†µæœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬è¦æ€è€ƒå„ç§å¼‚å¸¸å¯¼è‡´æ­»é”çš„æƒ…å†µï¼Œä¿è¯é”å¯ä»¥è¢«é‡Šæ”¾</li>
<p></p>
<p>  å°è¯•è·å–é”</p>
<p></p>
<p>   æˆåŠŸï¼šæ‰§è¡Œä¸šåŠ¡ä»£ç     æ‰§è¡Œä¸šåŠ¡  tryï¼ˆï¼‰{ä¸šåŠ¡ä»£ç -å®•æœº} catch() finally{ é‡Šæ”¾é”}</p>
<p></p>
<p>   å¤±è´¥ï¼šç­‰å¾…ï¼›å¤±æ•ˆï¼›ä¸‹æ¬¡</p>
<p></p>
<li>æ’å®ƒï¼šåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹è·å¾—é”</li>
<p></p>
<li>é«˜å¯ç”¨ï¼šé¿å…é”æœåŠ¡å®•æœºæˆ–å¤„ç†å¥½å®•æœºçš„è¡¥æ•‘æªæ–½(redisé›†ç¾¤æ¶æ„ï¼š1.ä¸»ä»å¤åˆ¶ 2.å“¨å…µ 3.clusteré›†ç¾¤)</li>
<p></p>
<p>åœ¨Redisä¸­æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼š</p>
<p></p>
<li><strong>å¤šè¿›ç¨‹å¯è§</strong>ï¼šå¤šè¿›ç¨‹å¯è§ï¼Œå¦åˆ™å°±æ— æ³•å®ç°åˆ†å¸ƒå¼æ•ˆæœ</li>
<p></p>
<p>  - redisæœ¬èº«å°±æ˜¯å¤šæœåŠ¡å…±äº«çš„ï¼Œå› æ­¤è‡ªç„¶æ»¡è¶³</p>
<p></p>
<li><strong>æ’å®ƒ</strong>ï¼šåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹è·å¾—é”</li>
<p></p>
<p>  - æˆ‘ä»¬éœ€è¦åˆ©ç”¨Redisçš„setnxå‘½ä»¤æ¥å®ç°ï¼Œsetnxæ˜¯set when not exitsçš„æ„æ€ã€‚å½“å¤šæ¬¡æ‰§è¡Œsetnxå‘½ä»¤æ—¶ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ‰ä¼šæˆåŠŸå¹¶è¿”å›1ï¼Œå…¶å®ƒæƒ…å†µè¿”å›0ï¼š</p>
<p>  - <img src="assets/1555935393771.png" alt="1555935393771" class="markdown-image"> </p>
<p>  - æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå›ºå®šçš„keyï¼Œå¤šä¸ªè¿›ç¨‹éƒ½æ‰§è¡Œsetnxï¼Œè®¾ç½®è¿™ä¸ªkeyçš„å€¼ï¼Œè¿”å›1çš„æœåŠ¡è·å–é”ï¼Œ0åˆ™æ²¡æœ‰è·å–</p>
<p></p>
<li><strong>é¿å…æ­»é”</strong>ï¼šæ­»é”çš„æƒ…å†µæœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬è¦æ€è€ƒå„ç§å¼‚å¸¸å¯¼è‡´æ­»é”çš„æƒ…å†µ</li>
<p></p>
<p>  - æ¯”å¦‚æœåŠ¡å®•æœºåçš„é”é‡Šæ”¾é—®é¢˜ï¼Œæˆ‘ä»¬è®¾ç½®é”æ—¶æœ€å¥½è®¾ç½®é”çš„æœ‰æ•ˆæœŸï¼Œå¦‚æœæœåŠ¡å®•æœºï¼Œæœ‰æ•ˆæœŸåˆ°æ—¶è‡ªåŠ¨åˆ é™¤é”ã€‚</p>
<p></p>
<p>    <img src="assets/1555935852042.png" alt="1555935852042" class="markdown-image"> </p>
<p></p>
<li><strong>é«˜å¯ç”¨</strong>ï¼šé¿å…é”æœåŠ¡å®•æœºæˆ–å¤„ç†å¥½å®•æœºçš„è¡¥æ•‘æªæ–½</li>
<p></p>
<p>  - åˆ©ç”¨Redisçš„ä¸»ä»ã€å“¨å…µã€é›†ç¾¤ï¼Œä¿è¯é«˜å¯ç”¨</p>
<p></p>
<h2>2.2 åˆ†å¸ƒå¼é”ç‰ˆæœ¬1</h2>
<p></p>
<h3>2.2.1 æµç¨‹</h3>
<p></p>
<p>æŒ‰ç…§ä¸Šé¢æ‰€è¿°çš„ç†è®ºï¼Œåˆ†å¸ƒå¼é”çš„æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<p></p>
<p><img src="assets/1555942085021.png" alt="1555942085021" class="markdown-image"> </p>
<p></p>
<p>åŸºæœ¬æµç¨‹ï¼š</p>
<p></p>
<li>1ã€é€šè¿‡setnxå‘½ä»¤è®¾ç½®é”</li>
<li>2ã€åˆ¤æ–­è¿”å›ç»“æœæ˜¯å¦æ˜¯OK</li>
<p>  - 1ï¼‰Nilï¼Œè·å–å¤±è´¥ï¼Œç»“æŸæˆ–é‡è¯•ï¼ˆè‡ªæ—‹é”ï¼‰</p>
<p>  - 2ï¼‰OKï¼Œè·å–é”æˆåŠŸ</p>
<p>    - æ‰§è¡Œä¸šåŠ¡</p>
<p>    - é‡Šæ”¾é”ï¼ŒDEL åˆ é™¤keyå³å¯</p>
<li>3ã€å¼‚å¸¸æƒ…å†µï¼ŒæœåŠ¡å®•æœºã€‚è¶…æ—¶æ—¶é—´EXç»“æŸï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾é”</li>
<p></p>
<h3>2.2.2 ä»£ç å®ç°</h3>
<p></p>
<li>åˆ›å»ºdemoå·¥ç¨‹<code> redis_lock_demo</code></li>
<p></p>
<li>åœ¨redis_lock_demoå·¥ç¨‹ä¸­å¼•å…¥ä¾èµ–</li>
<p></p>
<p>   <pre><code class="language-xml">    &lt;parent&gt;</p>
<p>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</p>
<p>        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</p>
<p>        &lt;version&gt;2.1.7.RELEASE&lt;/version&gt;</p>
<p>        &lt;relativePath/&gt;</p>
<p>   &lt;/parent&gt;</p>
<p>   </p>
<p>   &lt;dependencies&gt;</p>
<p>       &lt;dependency&gt;</p>
<p>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</p>
<p>           &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</p>
<p>       &lt;/dependency&gt;</p>
<p>       &lt;dependency&gt;</p>
<p>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</p>
<p>           &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</p>
<p>           &lt;scope&gt;test&lt;/scope&gt;</p>
<p>       &lt;/dependency&gt;</p>
<p>   </p>
<p>       &lt;dependency&gt;</p>
<p>           &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</p>
<p>           &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</p>
<p>       &lt;/dependency&gt;</p>
<p>   </p>
<p>       &lt;dependency&gt;</p>
<p>           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</p>
<p>           &lt;artifactId&gt;lombok&lt;/artifactId&gt;</p>
<p>       &lt;/dependency&gt;</p>
<p>   </p>
<p>       &lt;dependency&gt;</p>
<p>           &lt;groupId&gt;org.redisson&lt;/groupId&gt;</p>
<p>           &lt;artifactId&gt;redisson&lt;/artifactId&gt;</p>
<p>           &lt;version&gt;3.10.6&lt;/version&gt;</p>
<p>       &lt;/dependency&gt;</p>
<p>   &lt;/dependencies&gt;</p>
<p>   </code></pre></p>
<p></p>
<li>åœ¨redis_lock_demoå·¥ç¨‹åˆ›å»ºcom.itheimaåŒ… æ–°å»ºå¯åŠ¨ç±»</li>
<p></p>
<p>   <pre><code class="language-java">   package com.itheima;</p>
<p>   </p>
<p>   import org.springframework.boot.SpringApplication;</p>
<p>   import org.springframework.boot.autoconfigure.SpringBootApplication;</p>
<p>   import org.springframework.scheduling.annotation.EnableScheduling;</p>
<p>   </p>
<p>   @EnableScheduling</p>
<p>   @SpringBootApplication</p>
<p>   public class LockRedisApplication {</p>
<p>       public static void main(String[] args) {</p>
<p>           SpringApplication.run(LockRedisApplication.class, args);</p>
<p>       }</p>
<p>   </p>
<p>   }</p>
<p>   </p>
<p>   </code></pre></p>
<p></p>
<li>åœ¨redis_lock_demoå·¥ç¨‹å®šä¹‰ä¸€ä¸ªé”æ¥å£ï¼š</li>
<p></p>
<pre><code class="language-java">package com.itheima.lock;
<p></p>
<p>public interface RedisLock {</p>
<p></p>
<p>    /*<em></p>
<p>     </em> å°è¯•è·å–é”</p>
<p>     <em></p>
<p>     </em> @param expiretime é”é‡Šæ”¾æ—¶é—´ å•ä½ä¸ºç§’</p>
<p>     <em> @return</p>
<p>     </em>/</p>
<p>    public Boolean tryLock(Long expiretime);</p>
<p></p>
<p></p>
<p>    /*<em></p>
<p>     </em> é‡Šæ”¾é”æ–¹æ³•</p>
<p>     <em>/</p>
<p>    public void unLock();</p>
<p></p>
<p>}</p>
<p></code></pre></p>
<p></p>
<li>åœ¨redis_lock_demoå·¥ç¨‹åœ¨com.itheima.lock.implä¸­å®šä¹‰å®ç°ç±»å®ç°ç‰ˆæœ¬ä¸€åˆ†å¸ƒå¼é”</li>
<p></p>
<pre><code class="language-java">package com.itheima.lock.impl;
<p></p>
<p>import com.itheima.lock.RedisLock;</p>
<p>import jdk.nashorn.internal.runtime.FindProperty;</p>
<p>import org.springframework.data.redis.core.StringRedisTemplate;</p>
<p></p>
<p>import java.nio.channels.Pipe;</p>
<p>import java.util.concurrent.TimeUnit;</p>
<p></p>
<p>/</em><em></p>
<p> </em> @author: itheima</p>
<p> <em> @create: 2021-11-08 09:51</p>
<p> </em>/</p>
<p>public class RedisLockV1 implements RedisLock {</p>
<p></p>
<p>    public StringRedisTemplate redisTemplate;</p>
<p></p>
<p></p>
<p>    private static final String redisKey = &quot;lock&quot;;</p>
<p>    private static final String redisVal = &quot;lock&quot;;</p>
<p></p>
<p>    /*<em></p>
<p>     </em> é€šè¿‡æ„é€ ä¼ å…¥æ“ä½œredisçš„RedisTemplateå¯¹è±¡</p>
<p>     <em>/</p>
<p>    public RedisLockV1(StringRedisTemplate redisTemplate) {</p>
<p>        this.redisTemplate = redisTemplate;</p>
<p>    }</p>
<p></p>
<p>    /</em><em></p>
<p>     </em> å°è¯•è·å–é”æ–¹æ³•  æ‰§è¡ŒredisæŒ‡ä»¤ setnx</p>
<p>     <em></p>
<p>     </em> @param expiretime é”é‡Šæ”¾æ—¶é—´ å•ä½ä¸ºç§’</p>
<p>     <em> @return</p>
<p>     </em>/</p>
<p>    @Override</p>
<p>    public Boolean tryLock(Long expiretime) {</p>
<p>        Boolean flag = redisTemplate.opsForValue().setIfAbsent(redisKey, redisVal, expiretime, TimeUnit.SECONDS);</p>
<p>        return flag;</p>
<p>    }</p>
<p></p>
<p>    /*<em></p>
<p>     </em> é‡Šæ”¾é”æ–¹æ³•</p>
<p>     <em>/</p>
<p>    @Override</p>
<p>    public void unLock() {</p>
<p>        redisTemplate.delete(redisKey);</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<li>åœ¨<code>redis_lock_demo</code>æ¨¡å—ä¸­com.itheima.taskåŒ…ä¸‹å®šæ—¶ä»»åŠ¡ä¸­ä½¿ç”¨é”ï¼š</li>
<p></p>
<pre><code class="language-java">package com.itheima.task;
<p></p>
<p>import com.itheima.lock.RedisLock;</p>
<p>import com.itheima.lock.impl.RedisLockV1;</p>
<p>import lombok.extern.slf4j.Slf4j;</p>
<p>import org.springframework.beans.factory.annotation.Autowired;</p>
<p>import org.springframework.data.redis.core.StringRedisTemplate;</p>
<p>import org.springframework.scheduling.annotation.Scheduled;</p>
<p>import org.springframework.stereotype.Component;</p>
<p></p>
<p>/</em><em></p>
<p> </em> @author: itheima</p>
<p> <em> @create: 2021-09-26 09:42</p>
<p> </em>/</p>
<p>@Slf4j</p>
<p>//@Component</p>
<p>public class DemoTask {</p>
<p></p>
<p></p>
<p>    @Autowired</p>
<p>    private StringRedisTemplate redisTemplate;</p>
<p></p>
<p>    /*<em></p>
<p>     </em> æ¨¡æ‹Ÿå®šæ—¶æŸ¥è¯¢å¾…å®¡æ ¸æ–‡æ¡£ï¼Œè°ƒç”¨é˜¿é‡Œäº‘å†…å®¹å®‰å…¨å®¡æ ¸å†…å®¹ï¼Œå¢åŠ ç§¯åˆ†</p>
<p>     <em>/</p>
<p>    @Scheduled(cron = &quot;0/1 </em> <em> </em> <em> ?&quot;)</p>
<p>    public void task(){</p>
<p>        //1.å°è¯•è·å–é”</p>
<p>        RedisLock lock = new RedisLockV1(redisTemplate);</p>
<p>        //2.è·å–é”ç»“æœ</p>
<p>        Boolean flag = lock.tryLock(5L);</p>
<p>        //2.1 å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–</p>
<p>        if(!flag){</p>
<p>            log.error(&quot;è·å–é”å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–ï¼&quot;);</p>
<p>            return;</p>
<p>        }</p>
<p>        //2.2 æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡</p>
<p>        try {</p>
<p>            log.info(&quot;è·å–é”æˆåŠŸ&quot;);</p>
<p>            log.info(&quot;-------æ‰§è¡Œä»»åŠ¡-----&quot;);</p>
<p>            Thread.sleep(500);</p>
<p>        } catch (Exception e) {</p>
<p>            e.printStackTrace();</p>
<p>            lock.unLock();</p>
<p>        } finally {</p>
<p>            //3.é‡Šæ”¾é”</p>
<p>            log.info(&quot;é‡Šæ”¾é”&quot;);</p>
<p>            lock.unLock();</p>
<p>        }</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p> <img src="assets/image-20210905104037385.png" alt="" class="markdown-image"> </p>
<p></p>
<p></p>
<p></p>
<h2>2.3 åˆ†å¸ƒå¼é”ç‰ˆæœ¬2</h2>
<p></p>
<p>åˆšæ‰çš„é”æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p></p>
<h3>2.3.1 é‡Šæ”¾é”çš„é—®é¢˜</h3>
<p></p>
<p>å¤§å®¶æ€è€ƒä¸€ä¸‹ï¼Œé‡Šæ”¾é”å°±æ˜¯ç”¨DELè¯­å¥æŠŠé”å¯¹åº”çš„keyç»™åˆ é™¤ï¼Œæœ‰æ²¡æœ‰è¿™ä¹ˆä¸€ç§å¯èƒ½æ€§ï¼š</p>
<p></p>
<li>ä¸‰ä¸ªè¿›ç¨‹ï¼šAå’ŒBå’ŒCï¼Œåœ¨æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è¡Œäº‰æŠ¢é”ï¼Œæ­¤æ—¶Aè·å–äº†é”ï¼Œå¹¶è®¾ç½®è‡ªåŠ¨è¿‡æœŸæ—¶é—´ä¸º10s</li>
<li>Aå¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼Œå› ä¸ºæŸç§åŸå› ï¼Œä¸šåŠ¡é˜»å¡ï¼Œè€—æ—¶è¶…è¿‡äº†10ç§’ï¼Œæ­¤æ—¶é”è‡ªåŠ¨é‡Šæ”¾äº†</li>
<li>Bæ°å¥½æ­¤æ—¶å¼€å§‹å°è¯•è·å–é”ï¼Œå› ä¸ºé”å·²ç»è‡ªåŠ¨é‡Šæ”¾ï¼ŒæˆåŠŸè·å–é”</li>
<li>Aæ­¤æ—¶ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œé‡Šæ”¾é”é€»è¾‘ï¼ˆåˆ é™¤keyï¼‰ï¼Œäºæ˜¯Bçš„é”è¢«é‡Šæ”¾äº†ï¼Œè€ŒBå…¶å®è¿˜åœ¨æ‰§è¡Œä¸šåŠ¡</li>
<li>æ­¤æ—¶è¿›ç¨‹Cå°è¯•è·å–é”ï¼Œä¹ŸæˆåŠŸäº†ï¼Œå› ä¸ºAæŠŠBçš„é”åˆ é™¤äº†ã€‚</li>
<p></p>
<p>é—®é¢˜å‡ºç°äº†ï¼šBå’ŒCåŒæ—¶è·å–äº†é”ï¼Œ<strong>è¿åäº†æ’å®ƒæ€§</strong>ï¼</p>
<p></p>
<p><img src="assets/image-20210802110514954.png" alt="image-20210802110514954" class="markdown-image"></p>
<p></p>
<p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬åº”è¯¥åœ¨åˆ é™¤é”ä¹‹å‰ï¼Œåˆ¤æ–­è¿™ä¸ªé”æ˜¯å¦æ˜¯è‡ªå·±è®¾ç½®çš„é”ï¼Œå¦‚æœä¸æ˜¯ï¼ˆä¾‹å¦‚è‡ªå·±çš„é”å·²ç»è¶…æ—¶é‡Šæ”¾ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸è¦åˆ é™¤äº†ã€‚</p>
<p></p>
<p></p>
<p></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š<strong>å¦‚ä½•å¾—çŸ¥å½“å‰è·å–é”çš„æ˜¯ä¸æ˜¯è‡ªå·±</strong>å‘¢ï¼Ÿ</p>
<p></p>
<p>å¯¹äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨set é”ï¼ˆvalï¼‰æ—¶ï¼Œå­˜å…¥è‡ªå·±çš„çº¿ç¨‹ä¿¡æ¯ï¼åˆ é™¤é”å‰ï¼Œåˆ¤æ–­ä¸‹é‡Œé¢çš„å€¼æ˜¯ä¸æ˜¯ä¸è‡ªå·±ç›¸ç­‰ï¼Œå¦‚æœä¸ç­‰ï¼Œå°±ä¸è¦åˆ é™¤äº†ã€‚</p>
<p></p>
<h3>2.3.2 æµç¨‹å›¾</h3>
<p></p>
<p>æ¥çœ‹ä¸‹æµç¨‹çš„å˜åŒ–ï¼š</p>
<p></p>
<p><img src="assets/1555944884321.png" alt="1555944884321" class="markdown-image"> </p>
<p></p>
<p>åœ¨é‡Šæ”¾é”ä¹‹å‰ï¼Œå¤šäº†ä¸€æ­¥æ ¹æ®åˆ¤æ–­ï¼Œåˆ¤æ–­é”çš„valueé‡Šæ”¾è·Ÿè‡ªå·±å­˜è¿›å»çš„ä¸€è‡´ã€‚</p>
<p></p>
<p>æ”¹è¿›--å­˜å…¥rediså€¼</p>
<p></p>
<li>key:lock</li>
<li>value:åŠ å…¥å½“å‰æ‰§è¡Œä»»åŠ¡çº¿ç¨‹ä¿¡æ¯</li>
<p></p>
<h3>2.3.4 ä»£ç å®ç°</h3>
<p></p>
<p>åœ¨<code>redis_lock_demo</code>æ¨¡å—ä¸­com.itheima.lock.implåŒ…ä¸‹æ–°å»ºSimpleRedisLockV2å®ç°æ–¹å¼äºŒ</p>
<p></p>
<pre><code class="language-java">package com.itheima.lock.impl;
<p></p>
<p>import com.itheima.lock.RedisLock;</p>
<p>import lombok.extern.slf4j.Slf4j;</p>
<p>import org.springframework.data.redis.core.StringRedisTemplate;</p>
<p></p>
<p>import java.util.UUID;</p>
<p>import java.util.concurrent.TimeUnit;</p>
<p></p>
<p>/</em><em></p>
<p> </em> @author: itheima</p>
<p> <em> @create: 2021-11-08 09:51</p>
<p> </em>/</p>
<p>@Slf4j</p>
<p>public class RedisLockV2 implements RedisLock {</p>
<p></p>
<p>    public StringRedisTemplate redisTemplate;</p>
<p></p>
<p></p>
<p>    private static final String redisKey = &quot;lock&quot;;</p>
<p></p>
<p></p>
<p>    private static final String redisVal_prefix = UUID.randomUUID().toString();</p>
<p></p>
<p>    /*<em></p>
<p>     </em> é€šè¿‡æ„é€ ä¼ å…¥æ“ä½œredisçš„RedisTemplateå¯¹è±¡</p>
<p>     <em>/</p>
<p>    public RedisLockV2(StringRedisTemplate redisTemplate) {</p>
<p>        this.redisTemplate = redisTemplate;</p>
<p>    }</p>
<p></p>
<p>    /</em><em></p>
<p>     </em> å°è¯•è·å–é”æ–¹æ³•  æ‰§è¡ŒredisæŒ‡ä»¤ setnx</p>
<p>     <em></p>
<p>     </em> @param expiretime é”é‡Šæ”¾æ—¶é—´ å•ä½ä¸ºç§’</p>
<p>     <em> @return</p>
<p>     </em>/</p>
<p>    @Override</p>
<p>    public Boolean tryLock(Long expiretime) {</p>
<p>        //å­˜å…¥çº¿ç¨‹ä¿¡æ¯</p>
<p>        String redisVal = redisVal_prefix+Thread.currentThread().getId()+&quot;-&quot;+Thread.currentThread().getName();</p>
<p>        Boolean flag = redisTemplate.opsForValue().setIfAbsent(redisKey, redisVal, expiretime, TimeUnit.SECONDS);</p>
<p>        return flag;</p>
<p>    }</p>
<p></p>
<p>    /*<em></p>
<p>     </em> é‡Šæ”¾é”æ–¹æ³•</p>
<p>     <em>/</p>
<p>    @Override</p>
<p>    public void unLock() {</p>
<p>        /</em><em></p>
<p>         </em> åˆ é™¤é”åˆ¤æ–­é”æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹çš„</p>
<p>         <em>/</p>
<p>        //1.å…ˆä»redisä¸­è·å–ç›®å‰å­˜åœ¨é”çš„å€¼</p>
<p>        String redisLoclVal = redisTemplate.opsForValue().get(redisKey);</p>
<p>        //2.è·å–å½“å‰çº¿ç¨‹é”çš„å€¼</p>
<p>        String currentThreadLockVal = redisVal_prefix + Thread.currentThread().getId() + &quot;-&quot; + Thread.currentThread().getName();</p>
<p>        if(currentThreadLockVal.equals(redisLoclVal)){</p>
<p>            log.info(&quot;é”æ˜¯è‡ªå·±çº¿ç¨‹ï¼Œé‡Šæ”¾é”&quot;);</p>
<p>            redisTemplate.delete(redisKey);</p>
<p>        }else{</p>
<p>            log.error(&quot;é”ä¸æ˜¯è‡ªå·±çš„ï¼Œä¸å¤„ç†&quot;);</p>
<p>        }</p>
<p></p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<p>ä¿®æ”¹ä»»åŠ¡ä¸­é”å¯¹è±¡æ”¹ä¸ºV2</p>
<p></p>
<p><img src="assets/image-20210603123749578.png" alt="image-20210603123749578" class="markdown-image"></p>
<p></p>
<h2>2.4 åˆ†å¸ƒå¼é”ç‰ˆæœ¬3</h2>
<p></p>
<p>åˆšæ‰çš„é”æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p></p>
<p>å¦‚æœæˆ‘ä»¬åœ¨è·å–é”ä»¥åï¼Œæ‰§è¡Œä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå†æ¬¡å°è¯•è·å–é”ï¼Œæ‰§è¡Œsetnxè‚¯å®šä¼šå¤±è´¥ï¼Œå› ä¸ºé”å·²ç»å­˜åœ¨äº†ã€‚è¿™æ ·å°±æ˜¯<strong>ä¸å¯é‡å…¥é”</strong>ï¼Œæœ‰å¯èƒ½å¯¼è‡´æ­»é”ã€‚</p>
<p></p>
<p>å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p></p>
<p>å½“ç„¶æ˜¯æƒ³åŠæ³•æ”¹é€ æˆ<strong>å¯é‡å…¥é”</strong>ã€‚</p>
<p></p>
<h3>2.4.1 é‡å…¥é”</h3>
<p></p>
<p>ä»€ä¹ˆå«åšå¯é‡å…¥é”å‘¢ï¼Ÿ</p>
<p></p>
<p>> å¯é‡å…¥é”ï¼Œä¹Ÿå«åšé€’å½’é”ï¼ŒæŒ‡çš„æ˜¯åœ¨åŒä¸€çº¿ç¨‹å†…ï¼Œå¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶å¯ä»¥è·å–åˆ°è¯¥é”ã€‚æ¢ä¸€ç§è¯´æ³•ï¼š<strong>åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è¿›å…¥åŒæ­¥ä»£ç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå·±å·²è·å–åˆ°çš„é”ã€‚</strong></p>
<p></p>
<p></p>
<p></p>
<p>å¯é‡å…¥é”å¯ä»¥é¿å…å› åŒä¸€çº¿ç¨‹ä¸­å¤šæ¬¡è·å–é”è€Œå¯¼è‡´æ­»é”å‘ç”Ÿã€‚</p>
<p></p>
<p></p>
<p></p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•å®ç°å¯é‡å…¥é”å‘¢ï¼Ÿ</p>
<p></p>
<p>å…¶ä¸­çš„å…³é”®ï¼Œå°±æ˜¯<strong>åœ¨é”å·²ç»è¢«ä½¿ç”¨æ—¶ï¼Œåˆ¤æ–­è¿™ä¸ªé”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœæ˜¯åˆ™å†æ¬¡è·å–</strong>ã€‚</p>
<p></p>
<p></p>
<p></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨seté”çš„å€¼æ˜¯ï¼Œ<strong>å­˜å…¥è·å–é”çš„çº¿ç¨‹çš„ä¿¡æ¯</strong>ï¼Œè¿™æ ·ä¸‹æ¬¡å†æ¥æ—¶ï¼Œå°±èƒ½çŸ¥é“å½“å‰æŒæœ‰é”çš„æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯å°±å…è®¸å†æ¬¡è·å–é”ã€‚</p>
<p></p>
<p></p>
<p></p>
<p>è¦æ³¨æ„ï¼Œå› ä¸ºé”çš„è·å–æ˜¯<strong>å¯é‡å…¥</strong>çš„ï¼Œå› æ­¤å¿…é¡»è®°å½•é‡å…¥çš„æ¬¡æ•°ï¼Œè¿™æ ·ä¸è‡³äºåœ¨é‡Šæ”¾é”æ—¶ä¸€ä¸‹å°±é‡Šæ”¾æ‰ï¼Œè€Œæ˜¯é€å±‚é‡Šæ”¾ã€‚å› æ­¤ï¼Œä¸èƒ½å†ä½¿ç”¨ç®€å•çš„key-valueç»“æ„ï¼Œè¿™é‡Œæ¨èä½¿ç”¨hashç»“æ„ï¼š</p>
<p></p>
<p></p>
<p></p>
<p><strong>Map<Stringï¼ˆredisKeyï¼‰, Map<String(hashKey),String(hashval)>></strong></p>
<p></p>
<li>keyï¼šlocké”åç§°</li>
<li>hashKeyï¼šçº¿ç¨‹ä¿¡æ¯</li>
<li>hashValueï¼šé‡å…¥æ¬¡æ•°ï¼Œé»˜è®¤1</li>
<p></p>
<p>é‡Šæ”¾é”æ—¶ï¼Œæ¯æ¬¡éƒ½æŠŠ<strong>é‡å…¥æ¬¡æ•°å‡ä¸€</strong>ï¼Œå‡åˆ°0è¯´æ˜å¤šæ¬¡è·å–é”çš„é€»è¾‘éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæ‰å¯ä»¥åˆ é™¤keyï¼Œé‡Šæ”¾é”</p>
<p></p>
<h3>2.4.2 æµç¨‹å›¾</h3>
<p></p>
<p>è¿™é‡Œé‡ç‚¹æ˜¯è·å–é”çš„æµç¨‹ï¼š</p>
<p></p>
<p><img src="assets/1556164092317.png" alt="1556164092317" class="markdown-image"></p>
<p></p>
<p>ä¸‹é¢æˆ‘ä»¬å‡è®¾é”çš„keyä¸ºâ€œ<code>lock</code>â€ï¼ŒhashKeyæ˜¯å½“å‰çº¿ç¨‹çš„idï¼šâ€œ<code>threadId</code>â€ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´å‡è®¾ä¸º20</p>
<p></p>
<p>è·å–é”çš„æ­¥éª¤ï¼š</p>
<p></p>
<li>1ã€åˆ¤æ–­lockæ˜¯å¦å­˜åœ¨ <code>EXISTS lock</code></li>
<p>  - å­˜åœ¨ï¼Œè¯´æ˜æœ‰äººè·å–é”äº†ï¼Œä¸‹é¢åˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·±çš„é”</p>
<p>    - åˆ¤æ–­å½“å‰çº¿ç¨‹idä½œä¸ºhashKeyæ˜¯å¦å­˜åœ¨ï¼š<code>HEXISTS lock threadId</code></p>
<p>      - ä¸å­˜åœ¨ï¼Œè¯´æ˜é”å·²ç»æœ‰äº†ï¼Œä¸”ä¸æ˜¯è‡ªå·±è·å–çš„ï¼Œé”è·å–å¤±è´¥ï¼Œend</p>
<p>      - å­˜åœ¨ï¼Œè¯´æ˜æ˜¯è‡ªå·±è·å–çš„é”ï¼Œé‡å…¥æ¬¡æ•°+1ï¼š<code>HINCRBY lock threadId 1</code>ï¼Œå»åˆ°æ­¥éª¤3</p>
<p>  - 2ã€ä¸å­˜åœ¨ï¼Œè¯´æ˜å¯ä»¥è·å–é”ï¼Œ<code>HSET key threadId 1</code></p>
<p>  - 3ã€è®¾ç½®é”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œ<code>EXPIRE lock 20</code></p>
<p></p>
<p>é‡Šæ”¾é”çš„æ­¥éª¤ï¼š</p>
<p></p>
<li>1ã€åˆ¤æ–­å½“å‰çº¿ç¨‹idä½œä¸ºhashKeyæ˜¯å¦å­˜åœ¨ï¼š<code>HEXISTS lock threadId</code></li>
<p>  - ä¸å­˜åœ¨ï¼Œè¯´æ˜é”å·²ç»å¤±æ•ˆï¼Œä¸ç”¨ç®¡äº†</p>
<p>  - å­˜åœ¨ï¼Œè¯´æ˜é”è¿˜åœ¨ï¼Œé‡å…¥æ¬¡æ•°å‡1ï¼š<code>HINCRBY lock threadId -1</code>ï¼Œè·å–æ–°çš„é‡å…¥æ¬¡æ•°</p>
<li>2ã€åˆ¤æ–­é‡å…¥æ¬¡æ•°æ˜¯å¦ä¸º0ï¼š</li>
<p>  - ä¸º0ï¼Œè¯´æ˜é”å…¨éƒ¨é‡Šæ”¾ï¼Œåˆ é™¤keyï¼š<code>DEL lock</code></p>
<p>  - å¤§äº0ï¼Œè¯´æ˜é”è¿˜åœ¨ä½¿ç”¨ï¼Œé‡ç½®æœ‰æ•ˆæ—¶é—´ï¼š<code>EXPIRE lock 20</code></p>
<p></p>
<p></p>
<p></p>
<h3>2.4.3 å®ç°åˆ†æ</h3>
<p></p>
<p>ä¸Šè¿°æµç¨‹æœ‰ä¸€ä¸ªæœ€å¤§çš„é—®é¢˜ï¼Œå°±æ˜¯æœ‰å¤§é‡çš„åˆ¤æ–­ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¿è¡Œæ—¶ï¼Œä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé™¤éèƒ½ä¿è¯<strong>æ‰§è¡Œ</strong></p>
<p></p>
<p><strong>å‘½ä»¤çš„åŸå­æ€§</strong>ã€‚</p>
<p></p>
<p>å› æ­¤ï¼Œè¿™é‡Œä½¿ç”¨javaä»£ç æ— æ³•å®ç°ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p></p>
<p>Redisæ”¯æŒä¸€ç§ç‰¹æ®Šçš„æ‰§è¡Œæ–¹å¼ï¼šluaè„šæœ¬æ‰§è¡Œï¼Œluaè„šæœ¬ä¸­å¯ä»¥å®šä¹‰å¤šæ¡è¯­å¥ï¼Œè¯­å¥æ‰§è¡Œå…·å¤‡åŸå­æ€§ã€‚</p>
<p></p>
<h2>2.5 Redisçš„Luaè„šæœ¬ï¼ˆäº†è§£ï¼‰</h2>
<p></p>
<p>å…¶å®å®ç°Redisçš„åŸå­æ“ä½œæœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚Redisäº‹åŠ¡ï¼Œä½†æ˜¯ç›¸æ¯”è€Œè¨€ï¼Œä½¿ç”¨Redisçš„Luaè„šæœ¬æ›´åŠ ä¼˜ç§€ï¼Œå…·æœ‰ä¸å¯æ›¿ä»£çš„å¥½å¤„ï¼š</p>
<p></p>
<li>åŸå­æ€§ï¼šredisä¼šå°†æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚</li>
<li>å¤ç”¨ï¼šå®¢æˆ·ç«¯å‘é€çš„è„šæœ¬ä¼šæ°¸ä¹…å­˜åœ¨redisä¸­ï¼Œä»¥åå¯ä»¥é‡å¤ä½¿ç”¨ï¼Œè€Œä¸”å„ä¸ªRediså®¢æˆ·ç«¯å¯ä»¥å…±ç”¨ã€‚</li>
<li>é«˜æ•ˆï¼šLuaè„šæœ¬è§£æåä¼šå½¢æˆç¼“å­˜ï¼Œä¸ç”¨æ¯æ¬¡æ‰§è¡Œéƒ½è§£æã€‚</li>
<li>å‡å°‘ç½‘ç»œå¼€é”€ï¼šLuaè„šæœ¬ç¼“å­˜åï¼Œå¯ä»¥å½¢æˆSHAå€¼ï¼Œä½œä¸ºç¼“å­˜çš„keyï¼Œä»¥åè°ƒç”¨å¯ä»¥ç›´æ¥æ ¹æ®SHAå€¼æ¥è°ƒç”¨è„šæœ¬ï¼Œä¸ç”¨æ¯æ¬¡å‘é€å®Œæ•´è„šæœ¬ï¼Œè¾ƒå°‘ç½‘ç»œå ç”¨å’Œæ—¶å»¶</li>
<p></p>
<h3>2.5.1 Redisè„šæœ¬å‘½ä»¤ï¼š</h3>
<p></p>
<p>é€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰è„šæœ¬ç›¸å…³å‘½ä»¤ï¼š</p>
<p></p>
<pre><code class="language-plaintext">help @scripting
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<p>æˆ‘ä»¬çœ‹ä¸€äº›å¸¸ç”¨å‘½ä»¤</p>
<p></p>
<p>> EVALå‘½ä»¤ï¼š</p>
<p></p>
<p><img src="assets/1556029159652.png" alt="1556029159652" class="markdown-image"> </p>
<p></p>
<p>ç›´æ¥æ‰§è¡Œä¸€æ®µè„šæœ¬ï¼Œå‚æ•°åŒ…æ‹¬ï¼š</p>
<p></p>
<li>scriptï¼šè„šæœ¬å†…å®¹ï¼Œæˆ–è€…è„šæœ¬åœ°å€</li>
<li>numkeysï¼šè„šæœ¬ä¸­ç”¨åˆ°çš„keyçš„æ•°é‡ï¼Œæ¥ä¸‹æ¥çš„numkeysä¸ªå‚æ•°ä¼šä½œä¸ºkeyå‚æ•°ï¼Œå‰©ä¸‹çš„ä½œä¸ºargå‚æ•°</li>
<li>keyï¼šä½œä¸ºkeyçš„å‚æ•°ï¼Œä¼šè¢«å­˜å…¥è„šæœ¬ç¯å¢ƒä¸­çš„KEYSæ•°ç»„ï¼Œè§’æ ‡ä»1å¼€å§‹</li>
<li>argï¼šå…¶å®ƒå‚æ•°ï¼Œä¼šè¢«å­˜å…¥è„šæœ¬ç¯å¢ƒä¸­çš„ARGVæ•°ç»„ï¼Œè§’æ ‡ä»1å¼€å§‹</li>
<p></p>
<p></p>
<p></p>
<p>ç¤ºä¾‹ï¼š<code>EVAL "return 'hello world!'" 0</code>ï¼Œå…¶ä¸­ï¼š</p>
<p></p>
<li><code>"return 'hello world!'"</code>ï¼šå°±æ˜¯è„šæœ¬çš„å†…å®¹ï¼Œç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰åˆ«çš„å‘½ä»¤</li>
<li><code>0</code>ï¼šå°±æ˜¯è¯´æ²¡æœ‰ç”¨keyå‚æ•°ï¼Œç›´æ¥è¿”å›</li>
<p></p>
<p>æ•ˆæœï¼š</p>
<p></p>
<p><img src="assets/1556030139226.png" alt="1556030139226" class="markdown-image"> </p>
<p></p>
<p></p>
<p></p>
<p>> SCRIPT LOADå‘½ä»¤</p>
<p></p>
<p><img src="assets/1556029464469.png" alt="1556029464469" class="markdown-image"> </p>
<p></p>
<p>å°†ä¸€æ®µè„šæœ¬ç¼–è¯‘å¹¶ç¼“å­˜èµ·æ¥ï¼Œç”Ÿæˆä¸€ä¸ªSHA1å€¼å¹¶è¿”å›ï¼Œä½œä¸ºè„šæœ¬å­—å…¸çš„keyï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚</p>
<p></p>
<p>å‚æ•°scriptå°±æ˜¯è„šæœ¬å†…å®¹æˆ–åœ°å€ã€‚</p>
<p></p>
<p>ä»¥ä¹‹å‰æ¡ˆä¾‹ä¸­çš„çš„è„šæœ¬ä¸ºä¾‹ï¼š</p>
<p></p>
<p><img src="assets/1556030196610.png" alt="1556030196610" class="markdown-image"> </p>
<p></p>
<p>æ­¤å¤„è¿”å›çš„<code>ada0bc9efe2392bdcc0083f7f8deaca2da7f32ec</code>å°±æ˜¯è„šæœ¬ç¼“å­˜åå¾—åˆ°çš„sha1å€¼ã€‚</p>
<p></p>
<p>åœ¨è„šæœ¬å­—å…¸ä¸­ï¼Œæ¯ä¸€ä¸ªè¿™æ ·çš„sha1å€¼ï¼Œå¯¹åº”ä¸€æ®µè§£æå¥½çš„è„šæœ¬ï¼š</p>
<p></p>
<p><img src="assets/1556030293491.png" alt="1556030293491" class="markdown-image"> </p>
<p></p>
<p></p>
<p></p>
<p>> EVALSHA å‘½ä»¤ï¼š</p>
<p></p>
<p><img src="assets/1556029524238.png" alt="1556029524238" class="markdown-image"> </p>
<p></p>
<p>ä¸EVALç±»ä¼¼ï¼Œæ‰§è¡Œä¸€æ®µè„šæœ¬ï¼ŒåŒºåˆ«æ˜¯é€šè¿‡è„šæœ¬çš„sha1å€¼ï¼Œå»è„šæœ¬ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œç„¶åæ‰§è¡Œï¼Œå‚æ•°ï¼š</p>
<p></p>
<li>sha1ï¼šå°±æ˜¯è„šæœ¬å¯¹åº”çš„sha1å€¼</li>
<p></p>
<p>æˆ‘ä»¬ç”¨åˆšåˆšç¼“å­˜çš„è„šæœ¬ä¸ºä¾‹ï¼š</p>
<p></p>
<p><img src="assets/1556030354363.png" alt="1556030354363" class="markdown-image"> </p>
<p></p>
<p></p>
<p></p>
<h3>2.5.2 LuaåŸºæœ¬è¯­æ³•</h3>
<p></p>
<p>Luaè„šæœ¬éµå¾ªLuaçš„åŸºæœ¬è¯­æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„ï¼š</p>
<p></p>
<p>> redis.call()å’Œredis.pcall()</p>
<p></p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯è°ƒç”¨rediså‘½ä»¤çš„å‡½æ•°ï¼ŒåŒºåˆ«åœ¨äºcallæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ä¼šç›´æ¥è¿”å›é”™è¯¯ï¼›pcallåˆ™åœ¨é‡åˆ°é”™è¯¯åï¼Œä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚åŸºæœ¬è¯­æ³•ç±»ä¼¼ï¼š</p>
<p></p>
<pre><code class="language-lua">redis.call(&quot;å‘½ä»¤åç§°&quot;, å‚æ•°1ï¼Œ å‚æ•°2 ...)
<p></code></pre></p>
<p></p>
<p>ä¾‹å¦‚è¿™æ ·çš„è„šæœ¬ï¼š<code>return redis.call('set', KEYS[1], ARGV[1])</code></p>
<p></p>
<li>'set'ï¼šå°±æ˜¯æ‰§è¡Œset å‘½ä»¤</li>
<li>KEYS[1]ï¼šä»è„šæœ¬ç¯å¢ƒä¸­KEYSæ•°ç»„é‡Œå–ç¬¬ä¸€ä¸ªkeyå‚æ•°</li>
<li>ARGV[1]ï¼šä»è„šæœ¬ç¯å¢ƒä¸­ARGVæ•°ç»„é‡Œå–ç¬¬ä¸€ä¸ªargå‚æ•°</li>
<p></p>
<p>å®Œæ•´ç¤ºä¾‹ï¼š</p>
<p></p>
<p><img src="assets/1556031114634.png" alt="1556031114634" class="markdown-image"> </p>
<p></p>
<p>æ‰§è¡Œè¿™æ®µè„šæœ¬æ—¶ä¼ å…¥çš„å‚æ•°ï¼š</p>
<p></p>
<li>1ï¼šå£°æ˜keyåªæœ‰ä¸€ä¸ªï¼Œæ¥ä¸‹æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºkeyå‚æ•°</li>
<li>nameï¼škeyå‚æ•°ï¼Œä¼šè¢«å­˜å…¥åˆ°KEYSæ•°ç»„</li>
<li>Jackï¼šargå‚æ•°ï¼Œä¼šè¢«å­˜å…¥ARGVæ•°ç»„</li>
<p></p>
<p></p>
<p></p>
<p>> æ¡ä»¶åˆ¤æ–­å’Œå˜é‡</p>
<p></p>
<p>æ¡ä»¶åˆ¤æ–­è¯­æ³•ï¼š<code>if (æ¡ä»¶è¯­å¥) then ...; else ...; end;</code></p>
<p></p>
<p>å˜é‡æ¥æ”¶è¯­æ³•ï¼š<code>local num = 123;</code></p>
<p></p>
<p>ç¤ºä¾‹ï¼š</p>
<p></p>
<pre><code class="language-lua">local val = redis.call(&#039;get&#039;, KEYS[1]);
<p>if (val &gt; ARGV[1]) then </p>
<p>    return 1; </p>
<p>else </p>
<p>	return 0; </p>
<p>end;</p>
<p></code></pre></p>
<p></p>
<p>åŸºæœ¬é€»è¾‘ï¼šè·å–æŒ‡å®škeyçš„å€¼ï¼Œåˆ¤æ–­æ˜¯å¦å¤§äºæŒ‡å®šå‚æ•°ï¼Œå¦‚æœå¤§äºåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0</p>
<p></p>
<p>æ‰§è¡Œï¼š</p>
<p></p>
<p><img src="assets/1556032181883.png" alt="1556032181883" class="markdown-image"></p>
<p></p>
<li>å¯ä»¥çœ‹åˆ°numä¸€å¼€å§‹æ˜¯321ã€‚</li>
<li>æˆ‘ä»¬ä¿å­˜è„šæœ¬ï¼Œ</li>
<li>ç„¶åæ‰§è¡Œå¹¶ä¼ é€’numï¼Œ400ã€‚åˆ¤æ–­numæ˜¯å¦å¤§äº400ï¼Œ</li>
<li>ç»“æœè¿”å›0.</li>
<p></p>
<h3>2.5.3 ç¼–å†™åˆ†å¸ƒå¼é”è„šæœ¬</h3>
<p></p>
<p>è¿™é‡Œæˆ‘ä»¬å‡è®¾æœ‰3ä¸ªå‚æ•°ï¼š</p>
<p></p>
<li>KEYS[1]ï¼šå°±æ˜¯é”çš„åç§°key  redisKey</li>
<li>ARGV[1]ï¼šå°±æ˜¯çº¿ç¨‹idä¿¡æ¯  hashKey</li>
<li>ARGV[2]ï¼šé”è¿‡æœŸæ—¶é•¿  </li>
<p></p>
<p>é¦–å…ˆæ˜¯è·å–é”ï¼š</p>
<p></p>
<pre><code class="language-lua">if (redis.call(&#039;EXISTS&#039;, KEYS[1]) == 0) then  //åˆ¤æ–­é”ä¸å­˜åœ¨
<p>    redis.call(&#039;HSET&#039;, KEYS[1], ARGV[1], 1);</p>
<p>    redis.call(&#039;EXPIRE&#039;, KEYS[1], ARGV[2]);</p>
<p>    return 1;</p>
<p>end;</p>
<p>if (redis.call(&#039;HEXISTS&#039;, KEYS[1], ARGV[1]) == 1) then  //åˆ¤æ–­é”æ˜¯å¦æ˜¯çº¿ç¨‹è‡ªå·±çš„</p>
<p>    redis.call(&#039;HINCRBY&#039;, KEYS[1], ARGV[1], 1);</p>
<p>    redis.call(&#039;EXPIRE&#039;, KEYS[1], ARGV[2]);</p>
<p>    return 1;</p>
<p>end;</p>
<p>return 0;</p>
<p></code></pre></p>
<p></p>
<p>ç„¶åæ˜¯é‡Šæ”¾é”ï¼š</p>
<p></p>
<pre><code class="language-lua">if (redis.call(&#039;HEXISTS&#039;, KEYS[1], ARGV[1]) == 0) then
<p>    return nil;</p>
<p>end;</p>
<p>local count = redis.call(&#039;HINCRBY&#039;, KEYS[1], ARGV[1], -1);</p>
<p>if (count &gt; 0) then</p>
<p>    redis.call(&#039;EXPIRE&#039;, KEYS[1], ARGV[2]);</p>
<p>    return nil;</p>
<p>else</p>
<p>    redis.call(&#039;DEL&#039;, KEYS[1]);</p>
<p>    return nil;</p>
<p>end;</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<h3>2.5.4 Javaæ‰§è¡ŒLuaè„šæœ¬</h3>
<p></p>
<code>RedisTemplate</code>ä¸­æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥æ‰§è¡ŒLuaè„šæœ¬ï¼š
<p></p>
<p><img src="assets/1556162076875.png" alt="1556162076875" class="markdown-image"></p>
<p></p>
<p>åŒ…å«3ä¸ªå‚æ•°ï¼š</p>
<p></p>
<li><code>RedisScript<T> script</code>ï¼šå°è£…äº†Luaè„šæœ¬çš„å¯¹è±¡</li>
<li><code>List<K> keys</code>ï¼šè„šæœ¬ä¸­çš„keyçš„å€¼</li>
<li><code>Object ... args</code>ï¼šè„šæœ¬ä¸­çš„å‚æ•°çš„å€¼</li>
<p></p>
<p>å› æ­¤ï¼Œè¦æ‰§è¡ŒLuaè„šæœ¬ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠè„šæœ¬å°è£…åˆ°<code>RedisScript</code>å¯¹è±¡ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æ„å»º<code>RedisScript</code>å¯¹è±¡ï¼š</p>
<p></p>
<p>> æ–¹å¼1ï¼š</p>
<p></p>
<p>é€šè¿‡RedisScriptä¸­çš„é™æ€æ–¹æ³•ï¼š</p>
<p></p>
<p><img src="assets/1556162311151.png" alt="1556162311151" class="markdown-image"></p>
<p></p>
<p>è¿™ä¸ªæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p>
<p></p>
<li><code>String script</code>ï¼šLuaè„šæœ¬</li>
<li><code>Class<T> resultType</code>ï¼šè¿”å›å€¼ç±»å‹</li>
<p></p>
<p>éœ€è¦æŠŠè„šæœ¬å†…å®¹å†™åˆ°ä»£ç ä¸­ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä¸å¤Ÿä¼˜é›…ã€‚</p>
<p></p>
<p>> æ–¹å¼äºŒ</p>
<p></p>
<p>å¦ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯è‡ªå·±å»åˆ›å»º<code>RedisScript</code>çš„å®ç°ç±»<code>DefaultRedisScript</code>çš„å¯¹è±¡ï¼š</p>
<p></p>
<p><img src="assets/1556162540499.png" alt="1556162540499" class="markdown-image"></p>
<p></p>
<p>å¯ä»¥æŠŠè„šæœ¬æ–‡ä»¶å†™åˆ°classpathä¸‹çš„æŸä¸ªä½ç½®ï¼Œç„¶åé€šè¿‡åŠ è½½è¿™ä¸ªæ–‡ä»¶æ¥è·å–è„šæœ¬å†…å®¹ï¼Œå¹¶è®¾ç½®ç»™<code>DefaultRedisScript</code>å®ä¾‹ã€‚</p>
<p></p>
<p>æ­¤å¤„æˆ‘ä»¬é€‰æ‹©æ–¹å¼äºŒã€‚</p>
<p></p>
<h3>2.5.5 å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°</h3>
<p></p>
<p>é¦–å…ˆåœ¨classpathä¸­ç¼–å†™ä¸¤ä¸ªLuaè„šæœ¬æ–‡ä»¶ï¼š</p>
<p></p>
<p><img src="assets/1556162696842.png" alt="1556162696842" class="markdown-image"> </p>
<p></p>
<p>ç„¶åç¼–å†™ä¸€ä¸ªæ–°çš„RedisLockå®ç°ï¼šReentrantRedisLockï¼Œåˆ©ç”¨é™æ€ä»£ç å—æ¥åŠ è½½è„šæœ¬å¹¶åˆå§‹åŒ–ï¼š</p>
<p></p>
<p><img src="assets/1556163851408.png" alt="1556163851408" class="markdown-image"> </p>
<p></p>
<pre><code class="language-java">public class ReentrantRedisLock {
<p>    // è·å–é”çš„è„šæœ¬</p>
<p>    private static final DefaultRedisScript&lt;Long&gt; LOCK_SCRIPT;</p>
<p>    // é‡Šæ”¾é”çš„è„šæœ¬</p>
<p>    private static final DefaultRedisScript&lt;Object&gt; UNLOCK_SCRIPT;</p>
<p>    static {</p>
<p>        // åŠ è½½è·å–é”çš„è„šæœ¬</p>
<p>        LOCK_SCRIPT = new DefaultRedisScript&lt;&gt;();</p>
<p>        LOCK_SCRIPT.setScriptSource(new ResourceScriptSource(new ClassPathResource(&quot;lock.lua&quot;)));</p>
<p>        LOCK_SCRIPT.setResultType(Long.class);</p>
<p></p>
<p>        // åŠ è½½é‡Šæ”¾é”çš„è„šæœ¬</p>
<p>        UNLOCK_SCRIPT = new DefaultRedisScript&lt;&gt;();</p>
<p>        UNLOCK_SCRIPT.setScriptSource(new ResourceScriptSource(new ClassPathResource(&quot;unlock.lua&quot;)));</p>
<p>    }</p>
<p>    </p>
<p>    // å…¶å®ƒä»£ç ç•¥</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<p>ç„¶åå®ç°RedisLockå¹¶å®ç°lockå’Œunlockæ–¹æ³•ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<p></p>
<pre><code class="language-java">public class ReentrantRedisLock implements RedisLock {
<p></p>
<p>    private StringRedisTemplate redisTemplate;</p>
<p>    /</em><em></p>
<p>     </em> è®¾å®šå¥½é”å¯¹åº”çš„ key</p>
<p>     <em>/</p>
<p>    private String key;</p>
<p></p>
<p>    /</em><em></p>
<p>     </em> å­˜å…¥çš„çº¿ç¨‹ä¿¡æ¯çš„å‰ç¼€ï¼Œé˜²æ­¢ä¸å…¶å®ƒJVMä¸­çº¿ç¨‹ä¿¡æ¯å†²çª</p>
<p>     <em>/</p>
<p>    private final String ID_PREFIX = UUID.randomUUID().toString();</p>
<p></p>
<p>    public ReentrantRedisLock(StringRedisTemplate redisTemplate, String key) {</p>
<p>        this.redisTemplate = redisTemplate;</p>
<p>        this.key = key;</p>
<p>    }</p>
<p></p>
<p>    private static final DefaultRedisScript&lt;Long&gt; LOCK_SCRIPT;</p>
<p>    private static final DefaultRedisScript&lt;Object&gt; UNLOCK_SCRIPT;</p>
<p>    static {</p>
<p>        // åŠ è½½è·å–é”çš„è„šæœ¬</p>
<p>        LOCK_SCRIPT = new DefaultRedisScript&lt;&gt;();</p>
<p>        LOCK_SCRIPT.setScriptSource(new ResourceScriptSource(new ClassPathResource(&quot;lock.lua&quot;)));</p>
<p>        LOCK_SCRIPT.setResultType(Long.class);</p>
<p></p>
<p>        // åŠ è½½é‡Šæ”¾é”çš„è„šæœ¬</p>
<p>        UNLOCK_SCRIPT = new DefaultRedisScript&lt;&gt;();</p>
<p>        UNLOCK_SCRIPT.setScriptSource(new ResourceScriptSource(new ClassPathResource(&quot;unlock.lua&quot;)));</p>
<p>    }</p>
<p>    // é”é‡Šæ”¾æ—¶é—´</p>
<p>    private String releaseTime;</p>
<p></p>
<p>    @Override</p>
<p>    public boolean lock(long releaseTime) {</p>
<p>        // è®°å½•é‡Šæ”¾æ—¶é—´</p>
<p>        this.releaseTime = String.valueOf(releaseTime);</p>
<p>        // æ‰§è¡Œè„šæœ¬</p>
<p>        Long result = redisTemplate.execute(</p>
<p>                LOCK_SCRIPT,</p>
<p>                Collections.singletonList(key),</p>
<p>                ID_PREFIX + Thread.currentThread().getId(), this.releaseTime);</p>
<p>        // åˆ¤æ–­ç»“æœ</p>
<p>        return result != null &amp;&amp; result.intValue() == 1;</p>
<p>    }</p>
<p></p>
<p>    @Override</p>
<p>    public void unlock() {</p>
<p>        // æ‰§è¡Œè„šæœ¬</p>
<p>        redisTemplate.execute(</p>
<p>                UNLOCK_SCRIPT,</p>
<p>                Collections.singletonList(key),</p>
<p>                ID_PREFIX + Thread.currentThread().getId(), this.releaseTime);</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p>å®Œæˆï¼</p>
<p></p>
<h3>2.5.6 æµ‹è¯•</h3>
<p></p>
<p>æ–°å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæµ‹è¯•é‡å…¥é”ï¼š</p>
<p></p>
<pre><code class="language-java">package com.itheima.task.job;
<p></p>
<p>import com.itheima.task.utils.RedisLock;</p>
<p>import com.itheima.task.utils.ReentrantRedisLock;</p>
<p>import lombok.extern.slf4j.Slf4j;</p>
<p>import org.springframework.beans.factory.annotation.Autowired;</p>
<p>import org.springframework.data.redis.core.StringRedisTemplate;</p>
<p>import org.springframework.scheduling.annotation.Scheduled;</p>
<p>import org.springframework.stereotype.Component;</p>
<p></p>
<p></p>
<p>@Slf4j</p>
<p>@Component</p>
<p>public class ReentrantJob {</p>
<p></p>
<p>    @Autowired</p>
<p>    private StringRedisTemplate redisTemplate;</p>
<p></p>
<p>    private int max = 2;</p>
<p></p>
<p>    @Scheduled(cron = &quot;0/10 </em> <em> </em> <em> ?&quot;)</p>
<p>    public void hello() {</p>
<p>        // åˆ›å»ºé”å¯¹è±¡</p>
<p>        RedisLock lock = new ReentrantRedisLock(redisTemplate, &quot;lock&quot;);</p>
<p>        // æ‰§è¡Œä»»åŠ¡</p>
<p>        runTaskWithLock(lock, 1);</p>
<p>    }</p>
<p></p>
<p>    private void runTaskWithLock(RedisLock lock, int count) {</p>
<p>        // è·å–é”,è®¾ç½®è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º50s</p>
<p>        boolean isLock = lock.lock(50);</p>
<p>        // åˆ¤æ–­æ˜¯å¦è·å–é”</p>
<p>        if (!isLock) {</p>
<p>            // è·å–å¤±è´¥</p>
<p>            log.info(&quot;{}å±‚ è·å–é”å¤±è´¥ï¼Œåœæ­¢å®šæ—¶ä»»åŠ¡&quot;, count);</p>
<p>            return;</p>
<p>        }</p>
<p>        try {</p>
<p>            // æ‰§è¡Œä¸šåŠ¡</p>
<p>            log.info(&quot;{}å±‚ è·å–é”æˆåŠŸï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚&quot;, count);</p>
<p>            Thread.sleep(500);</p>
<p>            if(count &lt; max){</p>
<p>                runTaskWithLock(lock, count + 1);</p>
<p>            }</p>
<p>        } catch (InterruptedException e) {</p>
<p>            log.error(&quot;{}å±‚ ä»»åŠ¡æ‰§è¡Œå¤±è´¥&quot;, count, e);</p>
<p>        } finally {</p>
<p>            // é‡Šæ”¾é”</p>
<p>            lock.unlock();</p>
<p>            log.info(&quot;{}å±‚ ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé‡Šæ”¾é”&quot;, count);</p>
<p>        }</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p>DEBUGè¿è¡Œï¼Œæ‰“æ–­ç‚¹åœ¨è·å–é”åï¼Œæ‰§è¡Œä»»åŠ¡å‰ã€‚</p>
<p></p>
<h2>2.6 Redisson</h2>
<p></p>
<p>Redissonæ˜¯rediså®¢æˆ·ç«¯ï¼Œè·Ÿä¹‹å‰ä½¿ç”¨Jedisï¼Œè™½ç„¶æˆ‘ä»¬å·²ç»å®ç°äº†åˆ†å¸ƒå¼é”ï¼Œèƒ½å¤Ÿæ»¡è¶³å¤§å¤šæ•°æƒ…å†µä¸‹çš„éœ€æ±‚ï¼Œä¸è¿‡æˆ‘ä»¬çš„ä»£ç å¹¶ä¸æ˜¯ä¸‡æ— ä¸€å¤±ã€‚</p>
<p></p>
<p>æŸäº›åœºæ™¯ä¸‹ï¼Œå¯èƒ½éœ€è¦å®ç°åˆ†å¸ƒå¼çš„ä¸åŒç±»å‹é”ï¼Œæ¯”å¦‚ï¼šå…¬å¹³é”ã€äº’æ–¥é”ã€å¯é‡å…¥é”ã€è¯»å†™é”ã€çº¢é”ï¼ˆredLockï¼‰ç­‰ç­‰ã€‚å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚</p>
<p></p>
<p>è€Œå¼€æºæ¡†æ¶Redissonå°±å¸®æˆ‘ä»¬å®ç°äº†ä¸Šè¿°çš„è¿™äº› é”åŠŸèƒ½ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„å¼ºå¤§åŠŸèƒ½ã€‚</p>
<p></p>
<h3>2.6.1 ä»€ä¹ˆæ˜¯Redisson</h3>
<p></p>
<p>æ¥è‡ªå®˜ç½‘çš„ä¸€æ®µä»‹ç»ï¼š</p>
<p></p>
<p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ã€‚å…¶ä¸­åŒ…æ‹¬(<code>BitSet</code>, <code>Set</code>, <code>Multimap</code>, <code>SortedSet</code>, <code>Map</code>, <code>List</code>, <code>Queue</code>, <code>BlockingQueue</code>, <code>Deque</code>, <code>BlockingDeque</code>, <code>Semaphore</code>, <code>Lock</code>, <code>AtomicLong</code>, <code>CountDownLatch</code>, <code>Publish / Subscribe</code>, <code>Bloom filter</code>, <code>Remote service</code>, <code>Spring cache</code>, <code>Executor service</code>, <code>Live Object service</code>, <code>Scheduler service</code>) Redissonæä¾›äº†ä½¿ç”¨Redisçš„æœ€ç®€å•å’Œæœ€ä¾¿æ·çš„æ–¹æ³•ã€‚Redissonçš„å®—æ—¨æ˜¯ä¿ƒè¿›ä½¿ç”¨è€…å¯¹Redisçš„å…³æ³¨åˆ†ç¦»ï¼ˆSeparation of Concernï¼‰ï¼Œä»è€Œè®©ä½¿ç”¨è€…èƒ½å¤Ÿå°†ç²¾åŠ›æ›´é›†ä¸­åœ°æ”¾åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p>
<p></p>
<p><a href="https://redisson.org/" target="_blank" rel="noopener">å®˜ç½‘åœ°å€</a>ï¼šhttps://redisson.org/</p>
<p></p>
<p><a href="https://github.com/redisson/redisson" target="_blank" rel="noopener">GitHubåœ°å€</a>ï¼šhttps://github.com/redisson/redisson</p>
<p></p>
<p>çœ‹çœ‹Redissionèƒ½å®ç°çš„åŠŸèƒ½ï¼š</p>
<p></p>
<p><img src="assets/1556163395067.png" alt="1556163395067" class="markdown-image"> </p>
<p></p>
<p><img src="assets/1556163419648.png" alt="1556163419648" class="markdown-image"> </p>
<p></p>
<p> <img src="assets/1556163437101.png" alt="1556163437101" class="markdown-image"></p>
<p></p>
<p><img src="assets/1556163483872.png" alt="1556163483872" class="markdown-image"> </p>
<p></p>
<p>éå¸¸å¼ºå¤§è€Œä¸”ä¸°å¯Œï¼</p>
<p></p>
<h3>2.6.2 ä½¿ç”¨Redissonåˆ†å¸ƒå¼é”</h3>
<p></p>
<p>Redissonä¸­çš„åˆ†å¸ƒå¼é”ç§ç±»ä¸°å¯Œï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå› æ­¤ä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼é”åŠŸèƒ½æ˜¯å¼€å‘æ—¶çš„é¦–é€‰æ–¹æ¡ˆã€‚æˆ‘ä»¬ä¸€èµ·æ¥è¯•ä¸€ä¸‹ã€‚</p>
<p></p>
<h4>2.6.2.1 ä¾èµ–</h4>
<p></p>
<p>åœ¨<code>redis_lock_demo</code>æ¨¡å—ä¸­å¼•å…¥Redissionä¾èµ–ï¼š</p>
<p></p>
<pre><code class="language-xml">&lt;dependency&gt;
<p>    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</p>
<p>    &lt;artifactId&gt;redisson&lt;/artifactId&gt;</p>
<p>    &lt;version&gt;3.10.6&lt;/version&gt;</p>
<p>&lt;/dependency&gt;</p>
<p></code></pre></p>
<p></p>
<p>åœ¨åœ¨<code>redis_lock_demo</code>æ¨¡å—ä¸­application.ymlä¸­æŒ‡å®šredisæœåŠ¡å™¨åœ°å€ä¿¡æ¯</p>
<p></p>
<pre><code class="language-yaml">spring:
<p>  redis:</p>
<p>    host: localhost</p>
<p>    port: 6379</p>
<p></code></pre></p>
<p></p>
<h4>é…ç½®</h4>
<p></p>
<p>åœ¨<code>redis_lock_demo</code>æµ‹è¯•å·¥ç¨‹ä¸­æ¨¡å—ä¸­é…ç½®Redissonå®¢æˆ·ç«¯ï¼š</p>
<p></p>
<pre><code class="language-java">package com.itheima.config;
<p></p>
<p>import org.redisson.Redisson;</p>
<p>import org.redisson.api.RedissonClient;</p>
<p>import org.redisson.config.Config;</p>
<p>import org.springframework.boot.autoconfigure.data.redis.RedisProperties;</p>
<p>import org.springframework.context.annotation.Bean;</p>
<p>import org.springframework.context.annotation.Configuration;</p>
<p></p>
<p></p>
<p>@Configuration</p>
<p>public class RedisConfig {</p>
<p></p>
<p>    @Bean</p>
<p>    public RedissonClient redissonClient(RedisProperties prop) {</p>
<p>        String address = &quot;redis://%s:%d&quot;;</p>
<p>        Config config = new Config();</p>
<p>        config.useSingleServer()</p>
<p>                .setAddress(String.format(address, prop.getHost(), prop.getPort()));</p>
<p>        return Redisson.create(config);</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p>æ³¨æ„ï¼šè¿™é‡Œè¯»å–äº†ä¸€ä¸ªåä¸ºRedisPropertiesçš„å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬å¼•å…¥äº†SpringDataRedisï¼ŒSpringå·²ç»è‡ªåŠ¨åŠ è½½äº†RedisPropertiesï¼Œå¹¶ä¸”è¯»å–äº†é…ç½®æ–‡ä»¶ä¸­çš„Redisä¿¡æ¯ã€‚</p>
<p></p>
<h4>å¸¸ç”¨API</h4>
<p></p>
<p>RedissClientä¸­å®šä¹‰äº†å¸¸è§çš„é”ï¼š</p>
<p></p>
<p><img src="assets/1556169332323.png" alt="1556169332323" class="markdown-image"> </p>
<p></p>
<pre><code class="language-java">// åˆ›å»ºé”å¯¹è±¡ï¼Œå¹¶åˆ¶å®šé”çš„åç§°
<p>RLock lock = redissonClient.getLock(&quot;taskLock&quot;);</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<p>è·å–é”å¯¹è±¡åï¼Œå¯ä»¥é€šè¿‡<code>tryLock()</code>æ–¹æ³•è·å–é”ï¼š</p>
<p></p>
<p><img src="assets/1556169690541.png" alt="1556169690541" class="markdown-image"></p>
<p></p>
<p>æœ‰3ä¸ªé‡è½½çš„æ–¹æ³•ï¼š</p>
<p></p>
<li>ä¸‰ä¸ªå‚æ•°ï¼šè·å–é”ï¼Œè®¾ç½®é”ç­‰å¾…æ—¶é—´<code>waitTime</code>ã€é‡Šæ”¾æ—¶é—´<code>leaseTime</code>ï¼Œæ—¶é—´å•ä½<code>unit</code>ã€‚</li>
<p>  - å¦‚æœè·å–é”å¤±è´¥åï¼Œä¼šåœ¨<code>waitTime  </code>å‡å»è·å–é”ç”¨æ—¶çš„å‰©ä½™æ—¶é—´æ®µå†…ç»§ç»­å°è¯•è·å–é”ï¼Œå¦‚æœä¾ç„¶è·å–å¤±è´¥ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥ï¼›</p>
<p>  - è·å–é”åï¼Œå¦‚æœè¶…è¿‡<code>leaseTime</code>æœªé‡Šæ”¾ï¼Œä¸ºé¿å…æ­»é”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p>
<li>ä¸¤ä¸ªå‚æ•°ï¼šè·å–é”ï¼Œè®¾ç½®é”ç­‰å¾…æ—¶é—´<code>time</code>ã€æ—¶é—´å•ä½<code>unit</code>ã€‚é‡Šæ”¾æ—¶é—´<code>leaseTime</code>æŒ‰ç…§é»˜è®¤çš„30s</li>
<li>ç©ºå‚ï¼šè·å–é”ï¼Œ<code>waitTime</code>é»˜è®¤0sï¼Œå³è·å–é”å¤±è´¥ä¸é‡è¯•ï¼Œ<code>leaseTime</code>é»˜è®¤30s</li></ul>
<p></p>
<p></p>
<p></p>
<p>ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä½¿ç”¨<code>unlock()</code>æ–¹æ³•é‡Šæ”¾é”ï¼š</p>
<p></p>
<p><img src="assets/1556170353278.png" alt="1556170353278" class="markdown-image"> </p>
<p></p>
<p></p>
<p></p>
<h4>å®Œæ•´æµ‹è¯•ä»£ç </h4>
<p></p>
<p>åœ¨<code>redis_lock_demo</code>æµ‹è¯•å·¥ç¨‹ä¸­æ–°å¢ä»»åŠ¡ç±»</p>
<p></p>
<pre><code class="language-java">package com.itheima.task;
<p></p>
<p>import com.itheima.lock.RedisLock;</p>
<p>import com.itheima.lock.impl.RedisLockV1;</p>
<p>import com.itheima.lock.impl.RedisLockV2;</p>
<p>import lombok.extern.slf4j.Slf4j;</p>
<p>import org.redisson.api.RLock;</p>
<p>import org.redisson.api.RedissonClient;</p>
<p>import org.springframework.beans.factory.annotation.Autowired;</p>
<p>import org.springframework.data.redis.core.StringRedisTemplate;</p>
<p>import org.springframework.scheduling.annotation.Scheduled;</p>
<p>import org.springframework.stereotype.Component;</p>
<p></p>
<p>/</em><em></p>
<p> </em> @author: itheima</p>
<p> <em> @create: 2021-09-26 09:42</p>
<p> </em>/</p>
<p>@Slf4j</p>
<p>@Component</p>
<p>public class DemoTask {</p>
<p></p>
<p></p>
<p>    @Autowired</p>
<p>    private StringRedisTemplate redisTemplate;</p>
<p></p>
<p>    /*<em></p>
<p>     </em>/</p>
<p>    //@Scheduled(cron = &quot;0/1 <em> </em> <em> </em> ?&quot;)</p>
<p>    //public void task(){</p>
<p>    //    //1.å°è¯•è·å–é”</p>
<p>    //    RedisLock lock = new RedisLockV2(redisTemplate);</p>
<p>    //    //2.è·å–é”ç»“æœ</p>
<p>    //    Boolean flag = lock.tryLock(5L);</p>
<p>    //    //2.1 å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–</p>
<p>    //    if(!flag){</p>
<p>    //        log.error(&quot;è·å–é”å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–ï¼&quot;);</p>
<p>    //        return;</p>
<p>    //    }</p>
<p>    //    //2.2 æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡</p>
<p>    //    try {</p>
<p>    //        log.info(&quot;è·å–é”æˆåŠŸ&quot;);</p>
<p>    //        log.info(&quot;-------æ‰§è¡Œä»»åŠ¡-æŸ¥è¯¢éœ€è¦å…³é—­è®¢å•-æ¢å¤åº“å­˜---&quot;);</p>
<p>    //        task();</p>
<p>    //        Thread.sleep(500);</p>
<p>    //    } catch (Exception e) {</p>
<p>    //        e.printStackTrace();</p>
<p>    //        lock.unLock();</p>
<p>    //    } finally {</p>
<p>    //        //3.é‡Šæ”¾é”</p>
<p>    //        log.info(&quot;é‡Šæ”¾é”&quot;);</p>
<p>    //        lock.unLock();</p>
<p>    //    }</p>
<p>    //}</p>
<p></p>
<p></p>
<p>    @Autowired</p>
<p>    private RedissonClient redissonClient;</p>
<p></p>
<p></p>
<p>    @Scheduled(cron = &quot;0/1 <em> </em> <em> </em> ?&quot;)</p>
<p>    public void task(){</p>
<p>        //1.å°è¯•è·å–é”</p>
<p>        RLock lock = redissonClient.getLock(&quot;alock&quot;);</p>
<p>        //2.è·å–é”ç»“æœ</p>
<p>        Boolean flag = lock.tryLock();</p>
<p>        //2.1 å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–</p>
<p>        if(!flag){</p>
<p>            log.error(&quot;è·å–é”å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•è·å–ï¼&quot;);</p>
<p>            return;</p>
<p>        }</p>
<p>        //2.2 æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡</p>
<p>        try {</p>
<p>            log.info(&quot;è·å–é”æˆåŠŸ&quot;);</p>
<p>            log.info(&quot;-------æ‰§è¡Œä»»åŠ¡-æŸ¥è¯¢éœ€è¦å…³é—­è®¢å•-æ¢å¤åº“å­˜---&quot;);</p>
<p>            Thread.sleep(500);</p>
<p>        } catch (Exception e) {</p>
<p>            e.printStackTrace();</p>
<p>            lock.unlock();</p>
<p>        } finally {</p>
<p>            //3.é‡Šæ”¾é”</p>
<p>            log.info(&quot;é‡Šæ”¾é”&quot;);</p>
<p>            lock.unlock();</p>
<p>        }</p>
<p>    }</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<h1>3 åˆ†å¸ƒå¼é”é¢è¯•é¢˜</h1>
<p></p>
<p>ç”±äºæ˜¯åšå•†åŸä¸šåŠ¡ï¼Œè¦é¢‘ç¹çš„å¯¹å•†å“åº“å­˜è¿›è¡Œæ‰£å‡ï¼Œåº”ç”¨æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œä¸ºé¿å…å¹¶å‘é€ æˆåº“å­˜<code>è¶…ä¹°è¶…å–</code>ç­‰é—®é¢˜ï¼Œé‡‡ç”¨ <code>redis</code> åˆ†å¸ƒå¼é”åŠ ä»¥æ§åˆ¶ã€‚æœ¬ä»¥ä¸ºç»™æ‰£åº“å­˜çš„ä»£ç åŠ ä¸Šé”<code>lock.tryLock</code>å°±ä¸‡äº‹å¤§å‰äº†</p>
<p></p>
<pre><code class="language-java">    /*<em>
<p>     </em> @author itheima</p>
<p>     */</p>
<p>   public String stockLock() {</p>
<p>        RLock lock = redissonClient.getLock(&quot;stockLock&quot;);</p>
<p>        try {</p>
<p>            //è·å–é”</p>
<p>            if (lock.tryLock(10, TimeUnit.SECONDS)) {</p>
<p>                //æ‰£å‡åº“å­˜</p>
<p>                ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>
<p>            } else {</p>
<p>                log.info(&quot;æœªè·å–åˆ°é”ä¸šåŠ¡ç»“æŸ..&quot;);</p>
<p>            }</p>
<p>        } catch (Exception e) {</p>
<p>             log.info(&quot;å¤„ç†å¼‚å¸¸&quot;, e);</p>
<p>        } </p>
<p>        return &quot;ok&quot;;</p>
<p>  }</p>
<p></p>
<p></code></pre></p>
<p></p>
<p>ç»“æœä¸šåŠ¡ä»£ç æ‰§è¡Œå®Œä»¥åæˆ‘å¿˜äº†é‡Šæ”¾é”<code>lock.unlock()</code>ï¼Œå¯¼è‡´<code>redis</code>çº¿ç¨‹æ± è¢«æ‰“æ»¡ï¼Œ<code>redis</code>æœåŠ¡å¤§é¢ç§¯æ•…éšœï¼Œé€ æˆåº“å­˜æ•°æ®æ‰£å‡æ··ä¹±</p>
<p></p>
<p>éšç€ ä½¿ç”¨<code>redis</code> é”çš„æ—¶é—´è¶Šé•¿ï¼Œå‘ç° <code>redis</code> é”çš„å‘è¿œæ¯”æƒ³è±¡ä¸­è¦å¤šã€‚å°±ç®—åœ¨é¢è¯•é¢˜å½“ä¸­<code>redis</code>åˆ†å¸ƒå¼é”çš„å‡ºé•œç‡ä¹Ÿæ¯”è¾ƒé«˜ï¼Œæ¯”å¦‚ï¼šâ€œç”¨é”é‡åˆ°è¿‡å“ªäº›é—®é¢˜ï¼Ÿâ€ ï¼Œâ€œåˆæ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿâ€ åŸºæœ¬éƒ½æ˜¯ä¸€å¥—è¿æ‹›é—®å‡ºæ¥çš„ã€‚</p>
<p></p>
<h4>é”æœªè¢«é‡Šæ”¾</h4>
<p></p>
<p>è¿™ç§æƒ…å†µæ˜¯ä¸€ç§ä½çº§é”™è¯¯ï¼Œç”±äºå½“å‰çº¿ç¨‹ è·å–åˆ°<code>redis</code> é”ï¼Œå¤„ç†å®Œä¸šåŠ¡åæœªåŠæ—¶é‡Šæ”¾é”ï¼Œå¯¼è‡´å…¶å®ƒçº¿ç¨‹ä¼šä¸€ç›´å°è¯•è·å–é”é˜»å¡ï¼Œä¾‹å¦‚ï¼šç”¨<code>Jedis</code>å®¢æˆ·ç«¯ä¼šæŠ¥å¦‚ä¸‹çš„é”™è¯¯ä¿¡æ¯</p>
<p></p>
<pre><code class="language-java">redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource from the pool
<p></p>
<p></code></pre></p>
<p></p>
<code>redisçº¿ç¨‹æ± </code>å·²ç»æ²¡æœ‰ç©ºé—²çº¿ç¨‹æ¥å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤ã€‚
<p></p>
<p>è§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æˆ‘ä»¬ç»†å¿ƒä¸€ç‚¹ï¼Œæ‹¿åˆ°é”çš„çº¿ç¨‹å¤„ç†å®Œä¸šåŠ¡åŠæ—¶é‡Šæ”¾é”ï¼Œå¦‚æœæ˜¯é‡å…¥é”æœªæ‹¿åˆ°é”åï¼Œçº¿ç¨‹å¯ä»¥é‡Šæ”¾å½“å‰è¿æ¥å¹¶ä¸”<code>sleep</code>ä¸€æ®µæ—¶é—´ã€‚</p>
<p></p>
<pre><code class="language-java">  public void lock() {
<p>      while (true) {</p>
<p>          boolean flag = this.getLock(key);</p>
<p>          if (flag) {</p>
<p>                TODO .........</p>
<p>          } else {</p>
<p>                // é‡Šæ”¾å½“å‰redisè¿æ¥</p>
<p>                redis.close();</p>
<p>                // ä¼‘çœ 1000æ¯«ç§’</p>
<p>                sleep(1000);</p>
<p>          }</p>
<p>        }</p>
<p>    }</p>
<p></code></pre></p>
<p></p>
<h4>é”äº’ç›¸é‡Šæ”¾</h4>
<p></p>
<p>æˆ‘ä»¬çŸ¥é“<code>Redis</code>å®ç°é”çš„åŸç†åœ¨äº <code>SETNX</code>å‘½ä»¤ã€‚å½“ <code>key</code>ä¸å­˜åœ¨æ—¶å°† <code>key</code>çš„å€¼è®¾ä¸º <code>value</code> ï¼Œè¿”å›å€¼ä¸º <code>1</code>ï¼›è‹¥ç»™å®šçš„ <code>key</code> å·²ç»å­˜åœ¨ï¼Œåˆ™ <code>SETNX</code>ä¸åšä»»ä½•åŠ¨ä½œï¼Œè¿”å›å€¼ä¸º <code>0</code> ã€‚</p>
<p></p>
<pre><code class="language-plaintext">SETNX key value
<p></code></pre></p>
<p></p>
<p>æˆ‘ä»¬æ¥è®¾æƒ³ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼š<code>A</code>ã€<code>B</code>ä¸¤ä¸ªçº¿ç¨‹æ¥å°è¯•ç»™<code>key</code> <code>myLock</code>åŠ é”ï¼Œ<code>Açº¿ç¨‹</code>å…ˆæ‹¿åˆ°é”ï¼ˆå‡å¦‚é”<code>3ç§’</code>åè¿‡æœŸï¼‰ï¼Œ<code>Bçº¿ç¨‹</code>å°±åœ¨ç­‰å¾…å°è¯•è·å–é”ï¼Œåˆ°è¿™ä¸€ç‚¹æ¯›ç—…æ²¡æœ‰ã€‚</p>
<p></p>
<p>é‚£å¦‚æœæ­¤æ—¶ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒè€—æ—¶ï¼Œæ‰§è¡Œæ—¶é—´å·²ç»è¶…è¿‡<code>redis</code>é”è¿‡æœŸæ—¶é—´ï¼Œè¿™æ—¶<code>Açº¿ç¨‹</code>çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼ˆåˆ é™¤<code>key</code>ï¼‰ï¼Œ<code>Bçº¿ç¨‹</code>æ£€æµ‹åˆ°<code>myLock</code>è¿™ä¸ª<code>key</code>ä¸å­˜åœ¨ï¼Œæ‰§è¡Œ <code>SETNX</code>å‘½ä»¤ä¹Ÿæ‹¿åˆ°äº†é”ã€‚</p>
<p></p>
<p>ä½†æ˜¯ï¼Œæ­¤æ—¶<code>Açº¿ç¨‹</code>æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘ä¹‹åï¼Œè¿˜æ˜¯ä¼šå»é‡Šæ”¾é”ï¼ˆåˆ é™¤<code>key</code>ï¼‰ï¼Œè¿™å°±å¯¼è‡´<code>Bçº¿ç¨‹</code>çš„é”è¢«<code>Açº¿ç¨‹</code>ç»™é‡Šæ”¾äº†ã€‚</p>
<p></p>
<p>ä¸ºé¿å…ä¸Šè¾¹çš„æƒ…å†µï¼Œä¸€èˆ¬æˆ‘ä»¬åœ¨æ¯ä¸ªçº¿ç¨‹åŠ é”æ—¶è¦å¸¦ä¸Šè‡ªå·±ç‹¬æœ‰çš„<code>value</code>å€¼æ¥æ ‡è¯†ï¼Œåªé‡Šæ”¾æŒ‡å®š<code>value</code>çš„<code>key</code>ï¼Œå¦åˆ™å°±ä¼šå‡ºç°é‡Šæ”¾é”æ··ä¹±çš„åœºæ™¯ã€‚</p>
<p></p>
<h4>æ•°æ®åº“äº‹åŠ¡è¶…æ—¶</h4>
<p></p>
<code>redis</code>é”å’‹è¿˜æ‰¯åˆ°æ•°æ®åº“äº‹åŠ¡ä¸Šæ¥äº†ï¼Ÿçœ‹ä¸‹è¾¹è¿™æ®µä»£ç ï¼š
<p></p>
<pre><code class="language-java">   @Transaction
<p>   public void lock() {</p>
<p>   </p>
<p>        while (true) {</p>
<p>            boolean flag = this.getLock(key);</p>
<p>            if (flag) {</p>
<p>                insert();  //é‡‡ç”¨è‡ªåŠ¨ç®¡ç†äº‹åŠ¡ï¼Œä¸šåŠ¡è€—æ—¶æ¯”è¾ƒé•¿ï¼ŒæŠ›å‡ºå¼‚å¸¸å›æ»š</p>
<p>            }</p>
<p>        }</p>
<p>    }</p>
<p></code></pre></p>
<p></p>
<p>ç»™è¿™ä¸ªæ–¹æ³•æ·»åŠ ä¸€ä¸ª<code>@Transaction</code>æ³¨è§£å¼€å¯äº‹åŠ¡ï¼Œå¦‚ä»£ç ä¸­æŠ›å‡ºå¼‚å¸¸è¿›è¡Œå›æ»šï¼Œè¦çŸ¥é“æ•°æ®åº“äº‹åŠ¡å¯æ˜¯æœ‰è¶…æ—¶æ—¶é—´é™åˆ¶çš„ï¼Œå¹¶ä¸ä¼šæ— æ¡ä»¶çš„ä¸€ç›´ç­‰ä¸€ä¸ªè€—æ—¶çš„æ•°æ®åº“æ“ä½œã€‚</p>
<p></p>
<p>æ¯”å¦‚ï¼šæˆ‘ä»¬è§£æä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå†å°†æ•°æ®å­˜å…¥åˆ°æ•°æ®åº“ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œå°±ä¼šå¯¼è‡´äº‹åŠ¡è¶…æ—¶è‡ªåŠ¨å›æ»šã€‚</p>
<p></p>
<p>ä¸€æ—¦ä½ çš„<code>key</code>é•¿æ—¶é—´è·å–ä¸åˆ°é”ï¼Œè·å–é”<code>ç­‰å¾…çš„æ—¶é—´</code>è¿œè¶…è¿‡æ•°æ®åº“äº‹åŠ¡<code>è¶…æ—¶æ—¶é—´</code>ï¼Œç¨‹åºå°±ä¼šæŠ¥å¼‚å¸¸ã€‚</p>
<p></p>
<p>ä¸€èˆ¬ä¸ºè§£å†³è¿™ç§é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†æ•°æ®åº“äº‹åŠ¡æ”¹ä¸ºæ‰‹åŠ¨æäº¤ã€å›æ»šäº‹åŠ¡ã€‚</p>
<p></p>
<pre><code class="language-java">    @Autowired
<p>    DataSourceTransactionManager dataSourceTransactionManager;</p>
<p></p>
<p>    @Transaction</p>
<p>    public void lock() {</p>
<p>        //æ‰‹åŠ¨å¼€å¯äº‹åŠ¡</p>
<p>        TransactionStatus transactionStatus = dataSourceTransactionManager.getTransaction(transactionDefinition);</p>
<p>        try {</p>
<p>            while (true) {</p>
<p>                boolean flag = this.getLock(key);</p>
<p>                if (flag) {</p>
<p>                    insert();</p>
<p>                    //æ‰‹åŠ¨æäº¤äº‹åŠ¡</p>
<p>                    dataSourceTransactionManager.commit(transactionStatus);</p>
<p>                }</p>
<p>            }</p>
<p>        } catch (Exception e) {</p>
<p>            //æ‰‹åŠ¨å›æ»šäº‹åŠ¡</p>
<p>            dataSourceTransactionManager.rollback(transactionStatus);</p>
<p>        }</p>
<p>    }</p>
<p></code></pre></p>
<p></p>
<h4>é”è¿‡æœŸäº†ä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ  </h4>
<p></p>
<p>è¿™ç§æƒ…å†µå’Œæˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„ç¬¬äºŒç§æ¯”è¾ƒç±»ä¼¼ï¼Œä½†è§£å†³æ€è·¯ä¸Šç•¥æœ‰ä¸åŒã€‚</p>
<p></p>
<p>åŒæ ·æ˜¯<code>redis</code>åˆ†å¸ƒå¼é”è¿‡æœŸï¼Œè€Œä¸šåŠ¡é€»è¾‘æ²¡æ‰§è¡Œå®Œçš„åœºæ™¯ï¼Œä¸è¿‡ï¼Œè¿™é‡Œæ¢ä¸€ç§æ€è·¯æƒ³é—®é¢˜ï¼Œ<strong>æŠŠ<code>redis</code>é”çš„è¿‡æœŸæ—¶é—´å†å¼„é•¿ç‚¹ä¸å°±è§£å†³äº†å—ï¼Ÿ</strong></p>
<p></p>
<p>é‚£è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŠ é”çš„æ—¶å€™ï¼Œæ‰‹åŠ¨è°ƒé•¿<code>redis</code>é”çš„è¿‡æœŸæ—¶é—´ï¼Œå¯è¿™ä¸ªæ—¶é—´å¤šé•¿åˆé€‚ï¼Ÿä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œæ—¶é—´æ˜¯ä¸å¯æ§çš„ï¼Œè°ƒçš„è¿‡é•¿åˆä¼šå½±å“æ“ä½œæ€§èƒ½ã€‚</p>
<p></p>
<p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p></p>
<p><strong>è¦æ˜¯<code>redis</code>é”çš„è¿‡æœŸæ—¶é—´èƒ½å¤Ÿè‡ªåŠ¨ç»­æœŸå°±å¥½äº†ã€‚</strong>å¦‚æœè¾¾åˆ°äº†è¶…æ—¶æ—¶é—´ï¼Œä½†ä¸šåŠ¡ä»£ç è¿˜æ²¡æ‰§è¡Œå®Œï¼Œéœ€è¦ç»™é”è‡ªåŠ¨ç»­æœŸã€‚</p>
<p></p>
<p>è·å–é”æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>TimerTask</code>ç±»ï¼Œæ¥å®ç°è‡ªåŠ¨ç»­æœŸçš„åŠŸèƒ½ï¼š</p>
<p></p>
<pre><code class="language-java">Timer timer = new Timer(); 
<p>timer.schedule(new TimerTask() {</p>
<p>    @Override</p>
<p>    public void run(Timeout timeout) throws Exception {</p>
<p>      //è‡ªåŠ¨ç»­æœŸé€»è¾‘</p>
<p>    }</p>
<p>}, 10000, TimeUnit.MILLISECONDS);</p>
<p></code></pre></p>
<p></p>
<p></p>
<p></p>
<p>è·å–é”ä¹‹åï¼Œè‡ªåŠ¨å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”10ç§’é’Ÿï¼Œè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡è¿‡æœŸæ—¶é—´ã€‚è¿™ç§æœºåˆ¶åœ¨redissonæ¡†æ¶ä¸­ï¼Œæœ‰ä¸ªæ¯”è¾ƒéœ¸æ°”çš„åå­—ï¼š<code>watch dog</code>ï¼Œå³ä¼ è¯´ä¸­çš„<code>çœ‹é—¨ç‹—</code>ã€‚å½“ç„¶è‡ªåŠ¨ç»­æœŸåŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼˜å…ˆæ¨èä½¿ç”¨luaè„šæœ¬å®ç°ï¼Œæ¯”å¦‚ï¼š</p>
<p></p>
<pre><code class="language-plaintext">if (redis.call(&#039;hexists&#039;, KEYS[1], ARGV[2]) == 1) then 
<p>   redis.call(&#039;pexpire&#039;, KEYS[1], ARGV[1]);</p>
<p>  return 1; </p>
<p>end;</p>
<p>return 0;</p>
<p></code></pre></p>
<p></p>
<p>éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼šåœ¨å®ç°è‡ªåŠ¨ç»­æœŸåŠŸèƒ½æ—¶ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ€»çš„è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥è·Ÿredissonä¿æŒä¸€è‡´ï¼Œè®¾ç½®æˆ30ç§’ã€‚å¦‚æœä¸šåŠ¡ä»£ç åˆ°äº†è¿™ä¸ªæ€»çš„è¿‡æœŸæ—¶é—´ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå°±ä¸å†è‡ªåŠ¨ç»­æœŸäº†ã€‚</p>
<p></p>
<p></p>
<p></p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬ä½¿ç”¨<code>redis</code>å®¢æˆ·ç«¯<code>redisson</code>ï¼Œ<code>redisson</code>å¾ˆå¥½çš„è§£å†³äº†<code>redis</code>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸€äº›æ£˜æ‰‹é—®é¢˜ï¼Œå®ƒçš„å®—æ—¨å°±æ˜¯è®©ä½¿ç”¨è€…å‡å°‘å¯¹<code>Redis</code>çš„å…³æ³¨ï¼Œå°†æ›´å¤šç²¾åŠ›ç”¨åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p>
<p></p>
<code>redisson</code>å¯¹åˆ†å¸ƒå¼é”åšäº†å¾ˆå¥½å°è£…ï¼Œåªéœ€è°ƒç”¨<code>API</code>å³å¯ã€‚
<p></p>
<pre><code class="language-java">RLock lock = redissonClient.getLock(&quot;stockLock&quot;);
<p></code></pre></p>
<p></p>
<code>redisson</code>åœ¨åŠ é”æˆåŠŸåï¼Œä¼šæ³¨å†Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç›‘å¬è¿™ä¸ªé”ï¼Œæ¯éš”10ç§’å°±å»æŸ¥çœ‹è¿™ä¸ªé”ï¼Œå¦‚æœè¿˜æŒæœ‰é”ï¼Œå°±å¯¹<code>è¿‡æœŸæ—¶é—´</code>è¿›è¡Œç»­æœŸã€‚é»˜è®¤è¿‡æœŸç»­æœŸæ—¶é—´30ç§’ã€‚è¿™ä¸ªæœºåˆ¶ä¹Ÿè¢«å«åšï¼šâ€œ<code>çœ‹é—¨ç‹—</code>â€ã€‚
<p></p>
<p><strong>ä¸¾ä¾‹å­</strong>ï¼šå‡å¦‚åŠ é”çš„æ—¶é—´æ˜¯30ç§’ï¼Œè¿‡10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä¸€æ—¦åŠ é”çš„ä¸šåŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå°±ä¼šè¿›è¡Œä¸€æ¬¡ç»­æœŸï¼ŒæŠŠé”çš„è¿‡æœŸæ—¶é—´å†æ¬¡é‡ç½®æˆ10ç§’ã€‚å¦‚æœè¶…è¿‡30ç§’å°±ä¸å†ç»­æœŸäº†ã€‚</p>
<p></p>
<p>é€šè¿‡åˆ†æä¸‹è¾¹<code>redisson</code>çš„æºç å®ç°å¯ä»¥å‘ç°ï¼Œä¸ç®¡æ˜¯<code>åŠ é”</code>ã€<code>è§£é”</code>ã€<code>ç»­çº¦</code>éƒ½æ˜¯å®¢æˆ·ç«¯æŠŠä¸€äº›å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œé€šè¿‡å°è£…åœ¨<code>Lua</code>è„šæœ¬ä¸­å‘é€ç»™<code>redis</code>ï¼Œä¿è¯è¿™æ®µå¤æ‚ä¸šåŠ¡é€»è¾‘æ‰§è¡Œçš„<code>åŸå­æ€§</code>ã€‚</p>
<p></p>
<p></p>
<p></p>
<p><img src="assets/image-20210926121905404.png" alt="image-20210926121905404" class="markdown-image"></p>
<p></p>
<h4>é”ç«äº‰é—®é¢˜</h4>
<p></p>
<p>â€‹	å¦‚æœæœ‰å¤§é‡éœ€è¦å†™å…¥æ•°æ®çš„ä¸šåŠ¡åœºæ™¯ï¼Œä½¿ç”¨æ™®é€šçš„redisåˆ†å¸ƒå¼é”æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†å¦‚æœæœ‰äº›ä¸šåŠ¡åœºæ™¯ï¼Œå†™å…¥çš„æ“ä½œæ¯”è¾ƒå°‘ï¼Œåè€Œæœ‰å¤§é‡è¯»å–çš„æ“ä½œã€‚è¿™æ ·ç›´æ¥ä½¿ç”¨æ™®é€šçš„redisåˆ†å¸ƒå¼é”ï¼Œä¼šä¸ä¼šæœ‰ç‚¹æµªè´¹æ€§èƒ½ï¼Ÿ</p>
<p></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œé”çš„ç²’åº¦è¶Šç²—ï¼Œå¤šä¸ªçº¿ç¨‹æŠ¢é”æ—¶ç«äº‰å°±è¶Šæ¿€çƒˆï¼Œé€ æˆå¤šä¸ªçº¿ç¨‹é”ç­‰å¾…çš„æ—¶é—´ä¹Ÿå°±è¶Šé•¿ï¼Œæ€§èƒ½ä¹Ÿå°±è¶Šå·®ã€‚æ‰€ä»¥ï¼Œæå‡redisåˆ†å¸ƒå¼é”æ€§èƒ½çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è¦æŠŠé”çš„ç²’åº¦å˜ç»†ã€‚</p>
<p></p>
<p><strong>æ–¹æ¡ˆä¸€ï¼šè¯»å†™é”</strong></p>
<p></p>
<p>åŠ é”çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­è¯»å†™æ•°æ®çš„å®‰å…¨æ€§ï¼Œå³ä¸ä¼šå‡ºç°æ•°æ®é”™è¯¯æˆ–è€…ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<p></p>
<p>ä½†åœ¨ç»å¤§å¤šæ•°å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸€èˆ¬æ˜¯è¯»æ•°æ®çš„é¢‘ç‡è¿œè¿œå¤§äºå†™æ•°æ®ã€‚è€Œçº¿ç¨‹é—´çš„å¹¶å‘è¯»æ“ä½œæ˜¯å¹¶ä¸æ¶‰åŠå¹¶å‘å®‰å…¨é—®é¢˜ï¼Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦ç»™è¯»æ“ä½œåŠ äº’æ–¥é”ï¼Œåªè¦ä¿è¯è¯»å†™ã€å†™å†™å¹¶å‘æ“ä½œä¸Šé”æ˜¯äº’æ–¥çš„å°±è¡Œï¼Œè¿™æ ·å¯ä»¥æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p>
<p></p>
<p>æˆ‘ä»¬ä»¥redissonæ¡†æ¶ä¸ºä¾‹ï¼Œå®ƒå†…éƒ¨å·²ç»å®ç°äº†è¯»å†™é”çš„åŠŸèƒ½ã€‚è¯»é”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p></p>
<pre><code class="language-java">RReadWriteLock readWriteLock = redisson.getReadWriteLock(&quot;readWriteLock&quot;);
<p>RLock rLock = readWriteLock.readLock();</p>
<p>try {</p>
<p>    rLock.lock();</p>
<p>    //ä¸šåŠ¡æ“ä½œ</p>
<p>} catch (Exception e) {</p>
<p>    log.error(e);</p>
<p>} finally {</p>
<p>    rLock.unlock();</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p>å†™é”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<p></p>
<pre><code class="language-java">RReadWriteLock readWriteLock = redisson.getReadWriteLock(&quot;readWriteLock&quot;);
<p>RLock rLock = readWriteLock.writeLock();</p>
<p>try {</p>
<p>    rLock.lock();</p>
<p>    //ä¸šåŠ¡æ“ä½œ</p>
<p>} catch (InterruptedException e) {</p>
<p>   log.error(e);</p>
<p>} finally {</p>
<p>    rLock.unlock();</p>
<p>}</p>
<p></code></pre></p>
<p></p>
<p>å°†è¯»é”å’Œå†™é”åˆ†å¼€ï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯æå‡è¯»æ“ä½œçš„æ€§èƒ½ï¼Œå› ä¸ºè¯»å’Œè¯»ä¹‹é—´æ˜¯å…±äº«çš„ï¼Œä¸å­˜åœ¨äº’æ–¥æ€§ã€‚è€Œæˆ‘ä»¬çš„å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œç»å¤§å¤šæ•°æ•°æ®æ“ä½œéƒ½æ˜¯è¯»æ“ä½œã€‚æ‰€ä»¥ï¼Œå¦‚æœæå‡äº†è¯»æ“ä½œçš„æ€§èƒ½ï¼Œä¹Ÿå°±ä¼šæå‡æ•´ä¸ªé”çš„æ€§èƒ½ã€‚</p>
<p></p>
<p><strong>æ–¹æ¡ˆäºŒï¼šé”åˆ†æ®µ</strong></p>
<p></p>
<p>æ­¤å¤–ï¼Œä¸ºäº†å‡å°é”çš„ç²’åº¦ï¼Œæ¯”è¾ƒå¸¸è§çš„åšæ³•æ˜¯å°†å¤§é”ï¼š<code>åˆ†æ®µ</code>ã€‚åœ¨javaä¸­<code>ConcurrentHashMap</code>ï¼Œå°±æ˜¯å°†æ•°æ®åˆ†ä¸º<code>16æ®µ</code>ï¼Œæ¯ä¸€æ®µéƒ½æœ‰å•ç‹¬çš„é”ï¼Œå¹¶ä¸”å¤„äºä¸åŒé”æ®µçš„æ•°æ®äº’ä¸å¹²æ‰°ï¼Œä»¥æ­¤æ¥æå‡é”çš„æ€§èƒ½ã€‚æ”¾åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š</p>
<p></p>
<p>â€‹	æ¯”å¦‚åœ¨ç§’æ€æ‰£åº“å­˜çš„åœºæ™¯ä¸­ï¼Œç°åœ¨çš„åº“å­˜ä¸­æœ‰2000ä¸ªå•†å“ï¼Œç”¨æˆ·å¯ä»¥ç§’æ€ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°è¶…å–çš„æƒ…å†µï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå¯ä»¥å¯¹åº“å­˜åŠ é”ã€‚å¦‚æœæœ‰1Wçš„ç”¨æˆ·ç«äº‰åŒä¸€æŠŠé”ï¼Œæ˜¾ç„¶ç³»ç»Ÿååé‡ä¼šéå¸¸ä½ã€‚</p>
<p></p>
<p>ä¸ºäº†æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°†åº“å­˜åˆ†æ®µï¼Œæ¯”å¦‚ï¼šåˆ†ä¸º100æ®µï¼Œè¿™æ ·æ¯æ®µå°±æœ‰20ä¸ªå•†å“å¯ä»¥å‚ä¸ç§’æ€ã€‚</p>
<p></p>
<p>åœ¨ç§’æ€çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠç”¨æˆ·idè·å–hashå€¼ï¼Œç„¶åé™¤ä»¥100å–æ¨¡ã€‚æ¨¡ä¸º1çš„ç”¨æˆ·è®¿é—®ç¬¬1æ®µåº“å­˜ï¼Œæ¨¡ä¸º2çš„ç”¨æˆ·è®¿é—®ç¬¬2æ®µåº“å­˜ï¼Œæ¨¡ä¸º3çš„ç”¨æˆ·è®¿é—®ç¬¬3æ®µåº“å­˜ï¼Œåé¢ä»¥æ­¤ç±»æ¨ï¼Œåˆ°æœ€åæ¨¡ä¸º100çš„ç”¨æˆ·è®¿é—®ç¬¬100æ®µåº“å­˜</p>
<p></p>
<p><img src="assets/image-20211201104222602.png" alt="image-20211201104222602" class="markdown-image"></p>
<p></p>
<p>å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯ä»¥å¤§å¤§çš„å‡å°‘é”çš„å†²çªã€‚ä»¥å‰å¤šä¸ªçº¿ç¨‹åªèƒ½åŒæ—¶ç«äº‰1æŠŠé”ï¼Œå°¤å…¶åœ¨ç§’æ€çš„åœºæ™¯ä¸­ï¼Œç«äº‰å¤ªæ¿€çƒˆäº†ï¼Œå…¶åæœæ˜¯å¯¼è‡´ç»å¤§æ•°çº¿ç¨‹åœ¨é”ç­‰å¾…ã€‚ç°åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰100æŠŠé”ï¼Œç­‰å¾…çš„çº¿ç¨‹å˜å°‘äº†ï¼Œä»è€Œç³»ç»Ÿååé‡ä¹Ÿå°±æå‡äº†ã€‚</p>
<p></p>
<h4>ä¸»ä»å¤åˆ¶çš„é—®é¢˜</h4>
<p></p>
<p>å¦‚æœrediså­˜åœ¨å¤šä¸ªå®ä¾‹ã€‚æ¯”å¦‚ï¼šåšäº†ä¸»ä»ï¼Œæˆ–è€…ä½¿ç”¨äº†å“¨å…µæ¨¡å¼ï¼ŒåŸºäºredisçš„åˆ†å¸ƒå¼é”çš„åŠŸèƒ½ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<p></p>
<p>å…·ä½“æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p></p>
<p>å‡è®¾redisç°åœ¨ç”¨çš„ä¸»ä»æ¨¡å¼ï¼Œ1ä¸ªmasterèŠ‚ç‚¹ï¼Œ3ä¸ªslaveèŠ‚ç‚¹ã€‚masterèŠ‚ç‚¹è´Ÿè´£å†™æ•°æ®ï¼ŒslaveèŠ‚ç‚¹è´Ÿè´£è¯»æ•°æ®ã€‚</p>
<p></p>
<p><img src="assets/image-20211201093303917.png" alt="image-20211201093303917" class="markdown-image"></p>
<p></p>
<p>æœ¬æ¥æ˜¯å’Œè°å…±å¤„ï¼Œç›¸å®‰æ— äº‹çš„ã€‚redisåŠ é”æ“ä½œï¼Œéƒ½åœ¨masterä¸Šè¿›è¡Œï¼ŒåŠ é”æˆåŠŸåï¼Œå†å¼‚æ­¥åŒæ­¥ç»™æ‰€æœ‰çš„slaveã€‚çªç„¶æœ‰ä¸€å¤©ï¼ŒmasterèŠ‚ç‚¹ç”±äºæŸäº›ä¸å¯é€†çš„åŸå› ï¼ŒæŒ‚æ‰äº†ã€‚</p>
<p></p>
<p>è¿™æ ·éœ€è¦æ‰¾ä¸€ä¸ªslaveå‡çº§ä¸ºæ–°çš„masterèŠ‚ç‚¹ï¼Œå‡å¦‚slave1è¢«é€‰ä¸¾å‡ºæ¥äº†ã€‚</p>
<p></p>
<p><img src="assets/image-20211201093332526.png" alt="image-20211201093332526" class="markdown-image"></p>
<p></p>
<p>å¦‚æœæœ‰ä¸ªé”Aæ¯”è¾ƒå¯¸ï¼ŒåˆšåŠ é”æˆåŠŸmasterå°±æŒ‚äº†ï¼Œè¿˜æ²¡æ¥å¾—åŠåŒæ­¥åˆ°slave1ã€‚è¿™æ ·ä¼šå¯¼è‡´æ–°masterèŠ‚ç‚¹ä¸­çš„é”Aä¸¢å¤±äº†ã€‚åé¢ï¼Œå¦‚æœæœ‰æ–°çš„çº¿ç¨‹ï¼Œä½¿ç”¨é”AåŠ é”ï¼Œä¾ç„¶å¯ä»¥æˆåŠŸï¼Œåˆ†å¸ƒå¼é”å¤±æ•ˆäº†ã€‚</p>
<p></p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p></p>
<p>ç­”ï¼šredissonæ¡†æ¶ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨çš„ç±»ï¼š<code>RedissonRedLock</code>ï¼Œä½¿ç”¨äº†Redlockç®—æ³•ã€‚</p>
<p></p>
<li>éœ€è¦æ­å»ºå‡ å¥—ç›¸äº’ç‹¬ç«‹çš„redisç¯å¢ƒï¼Œå‡å¦‚æˆ‘ä»¬åœ¨è¿™é‡Œæ­å»ºäº†5å¥—ã€‚</li>
<li>æ¯å¥—ç¯å¢ƒéƒ½æœ‰ä¸€ä¸ªredisson nodeèŠ‚ç‚¹ã€‚</li>
<li>å¤šä¸ªredisson nodeèŠ‚ç‚¹ç»„æˆäº†RedissonRedLockã€‚</li>
<li>ç¯å¢ƒåŒ…å«ï¼šå•æœºã€ä¸»ä»ã€å“¨å…µå’Œé›†ç¾¤æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ä¸€ç§æˆ–è€…å¤šç§æ··åˆã€‚</li>
<p></p>
<p><img src="assets/image-20211201093449672.png" alt="image-20211201093449672" class="markdown-image"></p>
<p></p>
<p>RedissonRedLockåŠ é”è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p></p>
<li>è·å–æ‰€æœ‰çš„redisson nodeèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¾ªç¯å‘æ‰€æœ‰çš„redisson nodeèŠ‚ç‚¹åŠ é”ï¼Œå‡è®¾èŠ‚ç‚¹æ•°ä¸ºNï¼Œä¾‹å­ä¸­Nç­‰äº5ã€‚</li>
<li>å¦‚æœåœ¨Nä¸ªèŠ‚ç‚¹å½“ä¸­ï¼Œæœ‰N/2 + 1ä¸ªèŠ‚ç‚¹åŠ é”æˆåŠŸäº†ï¼Œé‚£ä¹ˆæ•´ä¸ªRedissonRedLockåŠ é”æ˜¯æˆåŠŸçš„ã€‚</li>
<li>å¦‚æœåœ¨Nä¸ªèŠ‚ç‚¹å½“ä¸­ï¼Œå°äºN/2 + 1ä¸ªèŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œé‚£ä¹ˆæ•´ä¸ªRedissonRedLockåŠ é”æ˜¯å¤±è´¥çš„ã€‚</li>
<li>å¦‚æœä¸­é€”å‘ç°å„ä¸ªèŠ‚ç‚¹åŠ é”çš„æ€»è€—æ—¶ï¼Œå¤§äºç­‰äºè®¾ç½®çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™ç›´æ¥è¿”å›å¤±è´¥ã€‚</li></ol>
<p></p>
<p>ä½¿ç”¨Redlockç®—æ³•ï¼Œç¡®å®èƒ½è§£å†³å¤šå®ä¾‹åœºæ™¯ä¸­ï¼Œå‡å¦‚masterèŠ‚ç‚¹æŒ‚äº†ï¼Œå¯¼è‡´åˆ†å¸ƒå¼é”å¤±æ•ˆçš„é—®é¢˜ã€‚</p>
      </div>
    </article>
  </main>

  <footer>
    <p>Â© 2026 åŒ—è¾° Â· ä¿æŒå¥½å¥‡ï¼ŒæŒç»­æˆé•¿</p>
    <p style="margin-top: 6px; font-size: 0.9rem; color: #aaa;">
      æœ¬åšå®¢é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc/4.0/" style="color: var(--primary);">CC BY-NC 4.0</a> è®¸å¯ | 
      æºç æ‰˜ç®¡äº <a href="https://github.com/" style="color: var(--primary);">GitHub</a>
    </p>
  </footer>

  <script src="../../../js/theme.js"></script>
</body>
</html>
  